<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Business App - Christmas Edition</title>
<style>
  /* ---------- Christmas Theme ---------- */
  body {
    font-family: 'Arial', sans-serif;
    background: linear-gradient(to bottom right, #ffefef, #e5f5e0);
    color: #333;
    margin: 0;
    padding: 0;
  }
  h1,h2,h3 {
    color: #a10000; /* deep red */
  }
  .screen {
    display: none;
    padding: 20px;
  }
  button {
    background-color: #007a00; /* dark green */
    color: white;
    border: none;
    padding: 10px 15px;
    margin: 5px;
    border-radius: 6px;
    cursor: pointer;
    font-weight: bold;
  }
  button:hover { background-color: #005500; }
  input, select {
    padding: 8px;
    margin: 5px;
    border-radius: 5px;
    border: 1px solid #a10000;
  }
  .accountItem {
    padding: 8px;
    margin: 4px 0;
    background-color: #fff0f0;
    border-left: 4px solid #a10000;
    border-radius: 6px;
    cursor: pointer;
  }
  .accountItem:hover { background-color: #ffdada; }
  .selected { background-color: #a10000; color: white; }
  .history-item {
    padding: 6px;
    margin: 3px 0;
    border-left: 4px solid #007a00;
    background-color: #f4fff4;
    border-radius: 4px;
  }
  .history-item.add { border-color: green; }
  .history-item.remove { border-color: red; }
  .small { font-size: 0.8em; color: #555; }
  #adminControls {
    margin-top: 15px;
    padding: 15px;
    background-color: #ffe6e6;
    border-radius: 8px;
    border: 2px solid #a10000;
  }
  #extraVerse {
    margin-top: 15px;
    padding: 12px;
    background-color: #fffbe6;
    border-left: 6px solid #f4c542;
    border-radius: 6px;
    font-style: italic;
  }
  .segment {
    padding: 10px;
    margin: 8px 0;
    border-radius: 6px;
    border: 2px solid #a10000;
    background-color: #fff0f0;
  }
  .segment h3 { margin-top:0; }
</style>
</head>
<body>

<!-- ---------- Segments 1-4 ---------- -->
<div id="segment1" class="segment screen" style="display:block;">
  <h3>Segment 1 - Welcome</h3>
  <button id="adminBtn">Admin</button>
  <button id="userBtn">User</button>
</div>

<div id="segment2" class="segment screen">
  <h3>Segment 2 - Admin Login</h3>
  <input type="password" id="adminPassInput" placeholder="Password">
  <button id="adminLoginBtn">Login</button>
  <button id="adminResetButton">Reset Password</button>
</div>

<div id="segment3" class="segment screen">
  <h3>Segment 3 - User Select Account</h3>
  <div id="userAccountList"></div>
  <button id="userBackBtn">Back</button>
</div>

<div id="segment4" class="segment screen">
  <h3>Segment 4 - Main App</h3>
  <div><strong id="userRealName">Name:</strong></div>
  <div>Total Balance: <span id="totalMoney">0</span> UGX</div>
  
  <h3>History</h3>
  <div id="historyList"></div>

  <div id="adminControls">
    <h3>Admin Controls</h3>
    <input type="text" id="accFullName" placeholder="Full Name">
    <input type="text" id="accAlias" placeholder="Alias">
    <input type="text" id="accAge" placeholder="Age">
    <input type="text" id="accGender" placeholder="Gender">
    <input type="password" id="accPin" placeholder="PIN">
    <button id="createAccBtn">Create Account</button>
    <button id="editAccBtn">Edit Account</button>
    <button id="deleteAccBtn">Delete Account</button>
    <button id="resetUserPinBtn">Reset User PIN</button>
    <button id="resetAdminPassBtn">Reset Admin Password</button>
    <hr>
    <input type="number" id="amountInput" placeholder="Amount">
    <input type="text" id="reasonInput" placeholder="Reason">
    <button id="addMoneyBtn">Add Money</button>
    <button id="removeMoneyBtn">Remove Money</button>
  </div>

  <div id="extraVerse"></div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyDbW2RuOnSr4H7Cl0_CLu99ckPbrh2y4Gw",
  authDomain: "business-app-data.firebaseapp.com",
  databaseURL: "https://business-app-data-default-rtdb.firebaseio.com",
  projectId: "business-app-data",
  storageBucket: "business-app-data.firebasestorage.app",
  messagingSenderId: "64963134720",
  appId: "1:64963134720:web:f8dd72fbe82342b1f91fe5",
  measurementId: "G-21K1R3V7SH"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// ---------- State ----------
let mode = null;
let currentAccountKey = null;
let currentUserKey = null;
let accountsCache = {};
let listeners = [];

// ---------- Elements ----------
const segments = [
  document.getElementById('segment1'),
  document.getElementById('segment2'),
  document.getElementById('segment3'),
  document.getElementById('segment4')
];
const adminPassInput = document.getElementById('adminPassInput');
const adminLoginBtn = document.getElementById('adminLoginBtn');
const adminResetButton = document.getElementById('adminResetButton');
const userAccountList = document.getElementById('userAccountList');
const userBackBtn = document.getElementById('userBackBtn');
const accountListEl = document.getElementById('accountList');
const historyListEl = document.getElementById('historyList');
const totalMoneyEl = document.getElementById('totalMoney');
const userRealNameEl = document.getElementById('userRealName');
const accFullName = document.getElementById('accFullName');
const accAlias = document.getElementById('accAlias');
const accAge = document.getElementById('accAge');
const accGender = document.getElementById('accGender');
const accPin = document.getElementById('accPin');
const createAccBtn = document.getElementById('createAccBtn');
const editAccBtn = document.getElementById('editAccBtn');
const deleteAccBtn = document.getElementById('deleteAccBtn');
const resetUserPinBtn = document.getElementById('resetUserPinBtn');
const resetAdminPassBtn = document.getElementById('resetAdminPassBtn');
const addMoneyBtn = document.getElementById('addMoneyBtn');
const removeMoneyBtn = document.getElementById('removeMoneyBtn');
const amountInput = document.getElementById('amountInput');
const reasonInput = document.getElementById('reasonInput');
const extraVerseEl = document.getElementById('extraVerse');

// ---------- Helper ----------
function showSegment(index){ segments.forEach((s,i)=>s.style.display=(i===index?'block':'none')); }

// ---------- Welcome ----------
document.getElementById('adminBtn').onclick = ()=>{ mode='admin'; showSegment(1); };
document.getElementById('userBtn').onclick = ()=>{ mode='user'; showSegment(2); loadUserAccountList(); };

// ---------- Admin Login ----------
adminLoginBtn.onclick = async ()=>{
  const pass = (adminPassInput.value||'').trim();
  adminPassInput.value='';
  if(!pass) return alert('Enter a password');
  const snap = await db.ref('admin/password').get();
  if(!snap.exists()){ await db.ref('admin/password').set(pass); alert('Admin password created'); enterAdmin(); return; }
  if(snap.val()===pass){ enterAdmin(); } else alert('Wrong admin password');
};
adminResetButton.onclick = async ()=>{
  const ok = confirm('Reset admin password?'); if(!ok) return;
  const newPass = prompt('Enter new password'); if(!newPass) return;
  await db.ref('admin/password').set(newPass); alert('Admin password updated');
};
function enterAdmin(){ showSegment(3); document.getElementById('adminControls').style.display='block'; loadAccountList(); }

// ---------- User Flow ----------
async function loadUserAccountList(){
  const snap = await db.ref('accounts').get();
  userAccountList.innerHTML='';
  snap.forEach(child=>{
    const a = normalizeAccount(child.key, child.val());
    const div = document.createElement('div');
    div.className='accountItem';
    div.innerText = a.alias || ('acct-'+child.key.slice(-4));
    div.onclick = ()=>{ currentAccountKey = child.key; currentUserKey = currentAccountKey; enterUserView(); };
    userAccountList.appendChild(div);
  });
}
userBackBtn.onclick = ()=>{ showSegment(0); };

function normalizeAccount(key, raw){
  const a = raw||{};
  return {
    fullName: a.fullName || a.fullname || a.name || a.full_name || 'Unknown',
    alias: a.alias || a.aliasName || a.nickname || ('acct-'+key.slice(-4)),
    age: a.age || a.Age || '',
    gender: a.gender || a.sex || '',
    pin: a.pin || a.PIN || '',
    balance: (typeof a.balance!=='undefined')?a.balance:0
  };
}

// ---------- Bible Verse ----------
const verses = [{ ref:'Luke 2:10-11', text:'But the angel said to them, "Do not be afraid. I bring you good news that will cause great joy for all the people. Today in the town of David a Savior has been born to you; he is the Messiah, the Lord."' }];
function showVerse(){ const v=verses[0]; extraVerseEl.innerHTML=`<em>"${v.text}"</em><div class='small' style='margin-top:8px;'>${v.ref}</div>`; }
showVerse(); setInterval(showVerse,21600000);

// ---------- Load / Admin Functions ----------
function clearListeners(){ listeners.forEach(l=>l.off()); listeners=[]; }

async function loadAccountList(){
  const snap = await db.ref('accounts').get();
  accountsCache = {};
  userAccountList.innerHTML='';
  snap.forEach(async child=>{
    const key = child.key; const raw = child.val();
    const a = normalizeAccount(key, raw);
    accountsCache[key]=a;
    const div = document.createElement('div');
    div.className='accountItem';
    div.innerText = a.alias + (a.fullName?(' - '+a.fullName):'');
    div.onclick = ()=>{ currentAccountKey=key; document.querySelectorAll('.accountItem').forEach(el=>el.classList.remove('selected')); div.classList.add('selected'); loadAccountDetails(key); };
    userAccountList.appendChild(div);
  });
}

async function loadAccountDetails(key){
  if(!key) return;
  clearListeners();
  const ref = db.ref('accounts/'+key);
  ref.child('balance').on('value', snap=> totalMoneyEl.innerText = snap.val()||0);
  ref.child('history').on('value', snap=>{
    const val = snap.val()||{};
    historyListEl.innerHTML='';
    Object.values(val).sort((a,b)=>(b.timestamp||0)-(a.timestamp||0)).forEach(it=>{
      const div = document.createElement('div');
      div.className = 'history-item ' + (it.type==='add'?'add':'remove');
      const ts = it.timestamp ? new Date(it.timestamp).toLocaleString() : '';
      div.innerHTML = `<strong>${it.type==='add'?'+':'-'} ${it.amount} UGX</strong><div class='small'>${it.comment||it.reason||''}</div><div class='small'>${ts}</div>`;
      historyListEl.appendChild(div);
    });
  });
  const snap2 = await ref.get(); const a = normalizeAccount(key, snap2.val());
  userRealNameEl.innerText = 'Name: ' + a.fullName;
}

// ---------- Admin Controls ----------
createAccBtn.onclick = async ()=>{
  const fullName = (accFullName.value||'').trim();
  const alias = (accAlias.value||'').trim();
  const age = (accAge.value||'').trim();
  const gender = (accGender.value||'').trim();
  const pin = (accPin.value||'').trim();
  if(!fullName || !alias || !pin) return alert('Full name, alias, PIN required');
  const ref = db.ref('accounts').push();
  await ref.set({fullName,alias,age,gender,pin,balance:0});
  accFullName.value=''; accAlias.value=''; accAge.value=''; accGender.value=''; accPin.value='';
  loadAccountList();
};
editAccBtn.onclick = async ()=>{
  if(!currentAccountKey) return alert('Select account'); 
  const raw = (await db.ref('accounts/'+currentAccountKey).get()).val()||{};
  const fullName = prompt('Full name', raw.fullName||''); if(fullName===null) return;
  const alias = prompt('Alias', raw.alias||''); if(alias===null) return;
  const age = prompt('Age', raw.age||''); if(age===null) return;
  const gender = prompt('Gender', raw.gender||''); if(gender===null) return;
  await db.ref('accounts/'+currentAccountKey).update({fullName,alias,age,gender}); alert('Account updated'); loadAccountList();
};
deleteAccBtn.onclick = async ()=>{
  if(!currentAccountKey) return alert('Select account'); if(!confirm('Delete account?')) return;
  await db.ref('accounts/'+currentAccountKey).remove(); currentAccountKey=null; loadAccountList();
};
resetUserPinBtn.onclick = async ()=>{
  if(!currentAccountKey) return alert('Select account'); 
  const pin = prompt('Enter new 4-digit PIN'); if(!pin||pin.length!==4) return alert('PIN must be 4 digits');
  await db.ref('accounts/'+currentAccountKey+'/pin').set(pin); alert('User PIN updated');
};
resetAdminPassBtn.onclick = async ()=>{
  const newPass = prompt('Enter new admin password'); if(!newPass) return;
  await db.ref('admin/password').set(newPass); alert('Admin password updated');
};
addMoneyBtn.onclick = async ()=>{
  if(!currentAccountKey) return alert('Select account');
  const amt = Number(amountInput.value); if(!amt) return alert('Enter amount');
  const ref = db.ref('accounts/'+currentAccountKey);
  const balSnap = await ref.child('balance').get(); let bal = balSnap.exists()?balSnap.val():0; bal+=amt;
  await ref.child('balance').set(bal);
  await ref.child('history').push({type:'add',amount:amt,comment:(reasonInput.value||''),timestamp:Date.now()});
  amountInput.value=''; reasonInput.value='';
};
removeMoneyBtn.onclick = async ()=>{
  if(!currentAccountKey) return alert('Select account');
  const amt = Number(amountInput.value); if(!amt) return alert('Enter amount');
  const ref = db.ref('accounts/'+currentAccountKey);
  const balSnap = await ref.child('balance').get(); let bal = balSnap.exists()?balSnap.val():0; bal-=amt;
  await ref.child('balance').set(bal);
  await ref.child('history').push({type:'remove',amount:amt,comment:(reasonInput.value||''),timestamp:Date.now()});
  amountInput.value=''; reasonInput.value='';
};

// ---------- User View ----------
function enterUserView(){
  showSegment(3); document.getElementById('adminControls').style.display='none';
  loadAccountDetails(currentUserKey);
}

// ---------- Initial Migration ----------
(async function init(){
  const snap = await db.ref('accounts').get();
  if(snap.exists()){
    const updates = {};
    snap.forEach(child=>{
      const k = child.key; const raw = child.val();
      const norm = normalizeAccount(k, raw);
      const need = {};
      if(!raw) return;
      if(!raw.fullName && norm.fullName!=='Unknown') need.fullName = norm.fullName;
      if(!raw.alias && norm.alias) need.alias = norm.alias;
      if(typeof raw.balance==='undefined') need.balance = norm.balance;
      if(!raw.pin && norm.pin) need.pin = norm.pin;
      if(Object.keys(need).length>0) updates['accounts/'+k] = need;
    });
    if(Object.keys(updates).length>0) await db.ref().update(updates);
  }
})();
</script>
</body>
</html>
