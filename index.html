<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>$Cash App</title>
<link href="https://fonts.googleapis.com/css2?family=Luckiest+Guy&family=Montserrat:wght@400;700&display=swap" rel="stylesheet">
<style>
/* ---------------- Basic Reset ---------------- */
* {margin:0; padding:0; box-sizing:border-box; font-family:'Montserrat', sans-serif;}
body {
  min-height:100vh;
  background: linear-gradient(135deg, #ff4d4d, #ffe066, #5cd65c, #66ccff);
  padding:20px;
  display:flex; justify-content:center; align-items:center;
  color:#fff;
}

/* ---------------- African Pattern Frame ---------------- */
#appFrame {
  border: 12px solid;
  border-image: url('https://i.imgur.com/6QWyzEy.png') 30 round; /* example pattern */
  padding:20px;
  border-radius:20px;
  width:100%;
  max-width:950px;
  background:rgba(0,0,0,0.1);
}

/* ---------------- Home Screen ---------------- */
#homeScreen {text-align:center; transition:all 0.5s ease;}
#logo {font-family:'Luckiest Guy', cursive; font-size:64px; margin-bottom:12px; color:#ffeb3b; text-shadow:2px 2px 6px #000; animation:floatLogo 2s ease-in-out infinite alternate;}
@keyframes floatLogo {0%{transform:translateY(0px);}100%{transform:translateY(-10px);}}

#welcomeMsg {font-size:24px; margin-bottom:24px; line-height:1.4; color:#fff; text-shadow:1px 1px 4px #000;}
#loginSection h2 {margin-bottom:16px; font-size:20px;}
.loginBtn {padding:12px 20px; margin:10px; font-size:18px; font-weight:700; border:none; border-radius:12px; cursor:pointer; transition:0.3s; display:inline-flex; align-items:center; gap:8px;}
.loginBtn img{display:inline-block;}
.loginBtn:hover {transform:scale(1.05);}
#adminBtn {background:#2c3e50;}
#userBtn {background:#16a085;}

/* ---------------- Screens ---------------- */
#welcomeScreen, #adminLogin, #userSelect, #userPinScreen, #appScreen{display:none; text-align:center;}

/* ---------------- App Main ---------------- */
#mainContainer { display:flex; gap:15px; width:100%; min-height:75vh;}
.segment { flex:1; background:rgba(255,255,255,0.08); border-radius:12px; padding:15px; backdrop-filter: blur(6px); overflow-y:auto; box-shadow:0 6px 18px rgba(0,0,0,0.35);}
button {padding:10px; border:none; border-radius:8px; cursor:pointer; margin-top:10px; font-weight:700;}
.inputBox {width:100%; padding:10px; margin-top:10px; border-radius:8px; border:none; font-size:15px;}
.accountItem {background:rgba(255,255,255,0.06); padding:10px; border-radius:8px; margin-top:8px; cursor:pointer;}
.accountItem.selected {background:rgba(255,255,255,0.18); color:#000; font-weight:700;}
.history {max-height:60vh; overflow-y:auto; padding:8px;}
.history-item {padding:10px; margin-bottom:8px; border-radius:8px; color:#fff;}
.history-item.add {background:#2a8f4a;}
.history-item.remove {background:#b33a3c;}
#extraVerse {font-size:16px; line-height:1.4; text-align:center;}
.small {font-size:12px; opacity:0.9;}
@media(max-width:900px){ #mainContainer{flex-direction:column;} }

</style>
</head>
<body>
<div id="appFrame">

<!-- ---------------- Home Screen ---------------- -->
<div id="homeScreen">
  <div id="logo">$Cash App</div>
  <div id="welcomeMsg">
    Welcome to your Cash App!<br>
    Keep track of your savings, transactions, and account details easily.
  </div>
  <div id="loginSection">
    <h2>Login</h2>
    <button id="adminBtn" class="loginBtn"><img src="https://i.imgur.com/6wCqXwL.png" width="20"> Admin</button>
    <button id="userBtn" class="loginBtn"><img src="https://i.imgur.com/OVxKZfA.png" width="20"> User</button>
  </div>
</div>

<!-- ---------------- Admin Login ---------------- -->
<div id="adminLogin">
  <h3>Admin Login</h3>
  <input id="adminPassInput" type="password" class="inputBox" placeholder="Enter admin password" />
  <div>
    <button id="adminLoginBtn" style="background:#34495e; color:#fff;">Login</button>
    <button id="adminResetButton" style="background:#9b59b6; color:#fff; margin-left:8px;">Reset Admin Password</button>
  </div>
  <p class="small">If no admin password is set yet, entering one will create it.</p>
</div>

<!-- ---------------- User Select ---------------- -->
<div id="userSelect">
  <h3>Select your account (alias)</h3>
  <div id="userAccountList"></div>
  <button id="userBackBtn" style="margin-top:12px; background:#7f8c8d;">Back</button>
</div>

<!-- ---------------- User PIN Screen ---------------- -->
<div id="userPinScreen">
  <h3>Enter your 4-digit PIN</h3>
  <input id="userPinInput" type="password" maxlength="4" class="inputBox" style="width:160px; text-align:center; font-size:18px;" />
  <div>
    <button id="userPinBtn" style="background:#16a085; color:#fff;">Login</button>
    <button id="userBackBtn2" style="background:#7f8c8d; color:#fff; margin-left:8px;">Back</button>
  </div>
</div>

<!-- ---------------- Main App ---------------- -->
<div id="appScreen">
  <div id="mainContainer">

    <!-- Segment 1: Accounts -->
    <div class="segment" id="segment1">
      <h3>Accounts</h3>
      <div id="accountList"></div>
      <div id="adminControls" style="display:none; margin-top:14px;">
        <h4>Admin Controls</h4>
        <input id="accFullName" class="inputBox" placeholder="Full name (required)" />
        <input id="accAlias" class="inputBox" placeholder="Alias (shown to users)" />
        <input id="accAge" class="inputBox" placeholder="Age" />
        <input id="accGender" class="inputBox" placeholder="Gender" />
        <input id="accPin" class="inputBox" placeholder="4-digit PIN (required)" maxlength="4" />
        <div style="display:flex; gap:8px;">
          <button id="createAccBtn" style="background:#2980b9; color:#fff; flex:1;">Create Account</button>
          <button id="editAccBtn" style="background:#f39c12; color:#fff; flex:1;">Edit Selected</button>
        </div>
        <div style="display:flex; gap:8px; margin-top:8px;">
          <button id="deleteAccBtn" style="background:#e74c3c; color:#fff; flex:1;">Delete Selected</button>
          <button id="resetUserPinBtn" style="background:#27ae60; color:#fff; flex:1;">Reset User PIN</button>
        </div>
      </div>
    </div>

    <!-- Segment 2: Account Details -->
    <div class="segment" id="segment2">
      <h3>Account Details</h3>
      <div id="userRealName" style="font-size:18px; margin-bottom:8px; color:#fff;"></div>
      <div>Total: <strong><span id="totalMoney">0</span></strong> UGX</div>
      <input id="amountInput" class="inputBox" placeholder="Amount" type="number" />
      <input id="reasonInput" class="inputBox" placeholder="Reason / Comment" />
      <div style="display:flex; gap:8px;">
        <button id="addMoneyBtn" style="background:#27ae60; color:#fff; flex:1;">Add Money</button>
        <button id="removeMoneyBtn" style="background:#c0392b; color:#fff; flex:1;">Remove Money</button>
      </div>
      <p class="small">(Users see this page read-only after PIN login.)</p>
    </div>

    <!-- Segment 3: Transaction History -->
    <div class="segment" id="segment3">
      <h3>Transaction History</h3>
      <div class="history" id="historyList"></div>
    </div>

    <!-- Segment 4: Verse -->
    <div class="segment" id="segment4">
      <h3>Verse (Seasonal)</h3>
      <div id="extraVerse">Loading verse...</div>
      <p class="small">Verse rotates every 6 hours (local time).</p>
    </div>

  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script>
// ---------------- Firebase ----------------
const firebaseConfig = {
  apiKey: "AIzaSyDbW2RuOnSr4H7Cl0_CLu99ckPbrh2y4Gw",
  authDomain: "business-app-data.firebaseapp.com",
  databaseURL: "https://business-app-data-default-rtdb.firebaseio.com",
  projectId: "business-app-data",
  storageBucket: "business-app-data.firebasestorage.app",
  messagingSenderId: "64963134720",
  appId: "1:64963134720:web:f8dd72fbe82342b1f91fe5",
  measurementId: "G-21K1R3V7SH"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// ---------------- App State ----------------
let mode=null, currentAccountKey=null, currentUserKey=null, accountsCache={};

// ---------------- Elements ----------------
const homeScreen = document.getElementById('homeScreen');
const adminLogin = document.getElementById('adminLogin');
const userSelect = document.getElementById('userSelect');
const userPinScreen = document.getElementById('userPinScreen');
const appScreen = document.getElementById('appScreen');

const adminPassInput=document.getElementById('adminPassInput');
const accountListEl=document.getElementById('accountList');
const historyListEl=document.getElementById('historyList');
const totalMoneyEl=document.getElementById('totalMoney');
const userRealNameEl=document.getElementById('userRealName');

const accFullName=document.getElementById('accFullName');
const accAlias=document.getElementById('accAlias');
const accAge=document.getElementById('accAge');
const accGender=document.getElementById('accGender');
const accPin=document.getElementById('accPin');

const createAccBtn=document.getElementById('createAccBtn');
const editAccBtn=document.getElementById('editAccBtn');
const deleteAccBtn=document.getElementById('deleteAccBtn');
const resetUserPinBtn=document.getElementById('resetUserPinBtn');

const addMoneyBtn=document.getElementById('addMoneyBtn');
const removeMoneyBtn=document.getElementById('removeMoneyBtn');
const amountInput=document.getElementById('amountInput');
const reasonInput=document.getElementById('reasonInput');

const userAccountList=document.getElementById('userAccountList');
const userPinInput=document.getElementById('userPinInput');
const userPinBtn=document.getElementById('userPinBtn');
const userBackBtn=document.getElementById('userBackBtn');
const userBackBtn2=document.getElementById('userBackBtn2');

// ---------------- Login buttons ----------------
document.getElementById('adminBtn').onclick=()=>{
    mode='admin'; homeScreen.style.display='none'; adminLogin.style.display='block';
};
document.getElementById('userBtn').onclick=()=>{
    mode='user'; homeScreen.style.display='none'; userSelect.style.display='block';
    loadUserAccountList();
};
userBackBtn.onclick=()=>{userSelect.style.display='none'; homeScreen.style.display='block';};
userBackBtn2.onclick=()=>{userPinScreen.style.display='none'; userSelect.style.display='block';};

// ---------------- Admin Login ----------------
document.getElementById('adminLoginBtn').onclick=async()=>{
    const pass=(adminPassInput.value||'').trim(); adminPassInput.value='';
    if(!pass) return alert('Enter a password');
    const snap=await db.ref('admin/password').get();
    if(!snap.exists()){ await db.ref('admin/password').set(pass); alert('Admin password created'); enterAdmin(); return; }
    if(snap.val()===pass){ enterAdmin(); } else alert('Wrong password');
};
document.getElementById('adminResetButton').onclick=async()=>{
    const ok=confirm('Reset admin password?'); if(!ok) return;
    const newPass=prompt('Enter new admin password:'); if(!newPass) return;
    await db.ref('admin/password').set(newPass); alert('Admin password updated');
};

function enterAdmin(){
    adminLogin.style.display='none'; appScreen.style.display='block';
    document.getElementById('adminControls').style.display='block';
    loadAccountList();
}

// ---------------- User login ----------------
async function loadUserAccountList(){
    const snap=await db.ref('accounts').get();
    userAccountList.innerHTML='';
    snap.forEach(child=>{
        const a=normalizeAccount(child.key,child.val());
        const div=document.createElement('div');
        div.className='accountItem';
        div.innerText=a.alias||('acct-'+child.key.slice(-4));
        div.onclick=()=>{ currentAccountKey=child.key; userSelect.style.display='none'; userPinScreen.style.display='block'; };
        userAccountList.appendChild(div);
    });
}

userPinBtn.onclick=async()=>{
    const pin=(userPinInput.value||'').trim(); userPinInput.value='';
    if(!pin) return alert('Enter PIN');
    const snap=await db.ref('accounts/'+currentAccountKey+'/pin').get();
    if(!snap.exists()) return alert('PIN not set');
    if(snap.val()===pin){ currentUserKey=currentAccountKey; enterUserView(); } else alert('Incorrect PIN');
};

function enterUserView(){
    userPinScreen.style.display='none'; appScreen.style.display='block';
    document.getElementById('adminControls').style.display='none';
    addMoneyBtn.style.display='none'; removeMoneyBtn.style.display='none';
    loadAccountList(); loadAccountDetails(currentUserKey);
}

// ---------------- Account functions ----------------
function normalizeAccount(key,raw){
    const a=raw||{};
    return {
        fullName:a.fullName||a.fullname||a.name||a.full_name||'Unknown',
        alias:a.alias||a.aliasName||a.nickname||('acct-'+key.slice(-4)),
        age:a.age||a.Age||'',
        gender:a.gender||a.sex||'',
        pin:a.pin||a.PIN||'',
        balance:(typeof a.balance!=='undefined')?a.balance:((typeof a.total!=='undefined')?a.total:0)
    };
}

async function loadAccountList(){
    const snap=await db.ref('accounts').get(); accountsCache={}; accountListEl.innerHTML='';
    snap.forEach(async child=>{
        const key=child.key; const raw=child.val();
        const a=normalizeAccount(key,raw); accountsCache[key]=a;
        const div=document.createElement('div'); div.className='accountItem';
        div.innerText=a.alias + (a.fullName?(' - '+a.fullName):'');
        div.onclick=()=>{ currentAccountKey=key; document.querySelectorAll('#accountList .accountItem').forEach(el=>el.classList.remove('selected')); div.classList.add('selected'); loadAccountDetails(key);};
        accountListEl.appendChild(div);
    });
}

async function loadAccountDetails(key){
    if(!key) return;
    const acctRef=db.ref('accounts/'+key);
    const snap=await acctRef.get(); const raw=snap.val()||{};
    const a=normalizeAccount(key,raw);
    userRealNameEl.innerText='Name: '+a.fullName;
    totalMoneyEl.innerText=a.balance;
    const histSnap=await acctRef.child('history').get();
    const val=histSnap.val()||{};
    historyListEl.innerHTML='';
    const entries=Object.values(val).sort((x,y)=>(y.timestamp||0)-(x.timestamp||0));
    entries.forEach(it=>{
        const div=document.createElement('div'); div.className='history-item '+(it.type==='add'?'add':'remove');
        const comment=it.comment||it.reason||'';
        const ts=it.timestamp?new Date(it.timestamp).toLocaleString():'';
        div.innerHTML=`<strong>${it.type==='add'?'+':'-'} ${it.amount} UGX</strong><div class='small'>${comment}</div><div class='small'>${ts}</div>`;
        historyListEl.appendChild(div);
    });
}

// ---------------- Add/Remove Money (admin only) ----------------
createAccBtn.onclick=async()=>{
    const fullName=(accFullName.value||'').trim(); const alias=(accAlias.value||'').trim();
    const age=(acc
