<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>$Cash App</title>
<link href="https://fonts.googleapis.com/css2?family=Luckiest+Guy&family=Montserrat:wght@400;700&display=swap" rel="stylesheet">
<style>
  * { margin:0; padding:0; box-sizing:border-box; font-family:'Montserrat', sans-serif; }
  body {
    /* fixed stray space in URL */
    background: url('https://raw.githubusercontent.com/nganaezechiel/cash-app-assets/main/background.PNG') no-repeat center center fixed;
    background-size: cover;
    color: #fff;
  }

  #titleBar {
    font-family:'Luckiest Guy', cursive;
    font-size:58px;            /* slightly bigger */
    color:#ffeb3b;
    text-shadow:2px 2px 6px #000;
    text-align:center;
    margin:30px 0 8px 0;       /* moved lower */
    animation:floatLogo 2s ease-in-out infinite alternate;
  }
  @keyframes floatLogo {0%{transform:translateY(0px);}100%{transform:translateY(-10px);}}

  /* layout */
  #mainContainer { display:flex; gap:15px; width:100%; min-height:68vh; justify-content:center; padding-bottom:40px; }
  .sidePanel { flex:0.6; border-radius:12px; background:rgba(255,255,255,0.04); backdrop-filter: blur(6px); display:flex; justify-content:center; align-items:center; overflow:hidden; min-height:420px; box-shadow:0 6px 18px rgba(0,0,0,0.35);}
  .sidePanel img { max-width:100%; max-height:100%; object-fit:contain; border-radius:10px; transition:0.3s ease; }
  .sidePanel img:hover { transform:scale(1.03); }

  .segmentWrapper { flex:2; display:flex; flex-direction:column; gap:20px; max-width:760px; }

  .segment { flex:1; background:rgba(0,0,0,0.45); border-radius:12px; padding:18px; backdrop-filter: blur(4px); overflow-y:auto; box-shadow:0 6px 18px rgba(0,0,0,0.35); }
  h3 { color:#ffeb3b; margin-bottom:8px; }

  button { padding:10px; border:none; border-radius:8px; cursor:pointer; margin-top:10px; font-weight:700; transition:0.14s; }
  button:hover { opacity:0.95; transform:translateY(-2px); }
  .inputBox { width:100%; padding:10px; margin-top:10px; border-radius:8px; border:none; font-size:15px; }

  .accountItem { background:rgba(255,255,255,0.03); padding:10px; border-radius:8px; margin-top:8px; cursor:pointer; color:#fff; }
  .accountItem.selected { background:rgba(255,235,59,0.12); color:#000; font-weight:700; }

  .history { max-height:40vh; overflow-y:auto; padding:8px; }
  .history-item { padding:10px; margin-bottom:8px; border-radius:8px; color:#fff; }
  .history-item.add { background:#2a8f4a; }
  .history-item.remove { background:#b33a3a; }

  #welcomeScreen { height:70vh; display:flex; justify-content:center; align-items:center; flex-direction:column; }
  #welcomeBox { background:rgba(0,0,0,0.6); padding:28px; border-radius:15px; text-align:center; box-shadow:0 6px 20px rgba(0,0,0,0.4); min-width:320px; }
  #welcomeBox h3 { color:#fff; margin-bottom:8px; font-size:20px; }
  #welcomeBox p { color:#ccc; font-size:14px; margin-bottom:14px; }

  .small { font-size:12px; opacity:0.9; color:#ddd; }
  #readonlyNotice { text-align:center; margin-top:6px; color:#f0f0f0; font-style:italic; }

  @media(max-width:1050px){
    #mainContainer{flex-direction:column; align-items:center;}
    .sidePanel{width:90%; margin-bottom:12px; flex:unset;}
    .segmentWrapper{width:95%;}
    #titleBar { font-size:46px; margin-top:18px; }
  }
</style>
</head>
<body>

  <div id="titleBar">$Cash App</div>

  <!-- Welcome / Login -->
  <div id="welcomeScreen">
    <p style="text-align:center; font-size:18px; color:#fff; margin-bottom:20px;">
      Keep track of your savings, transactions, and account details easily.
    </p>

    <div id="welcomeBox">
      <h3>Who are you?</h3>
      <p>Please select your login type:</p>
      <div style="display:flex; justify-content:center; gap:12px; flex-wrap:wrap;">
        <button id="adminBtn" style="background:#2c3e50; color:#fff; width:140px;">Admin</button>
        <button id="userBtn" style="background:#16a085; color:#fff; width:140px;">User</button>
      </div>
    </div>
  </div>

  <!-- Admin login area (hidden initially) -->
  <div id="adminLogin" style="display:none; max-width:420px; margin:18px auto; text-align:center;">
    <div class="segment">
      <h3>Admin Login</h3>
      <input id="adminPassInput" type="password" class="inputBox" placeholder="Enter admin password" autocomplete="new-password" />
      <div style="display:flex; gap:10px; justify-content:center; margin-top:12px;">
        <button id="adminLoginBtn" style="background:#34495e; color:#fff;">Login</button>
        <button id="adminResetButton" style="background:#9b59b6; color:#fff;">Change Password</button>
      </div>
      <p class="small">If no admin password exists yet, this first password will be created (stored as a hash).</p>
    </div>
  </div>

  <!-- User selection / PIN (hidden initially) -->
  <div id="userSelect" style="display:none; max-width:420px; margin:18px auto; text-align:center;">
    <div class="segment">
      <h3>Select your account</h3>
      <div id="userAccountList" style="display:flex; flex-direction:column; gap:6px;"></div>
      <div style="margin-top:12px;">
        <button id="userCancelBtn" style="background:#7f8c8d; color:#fff;">Cancel</button>
      </div>
    </div>
  </div>

  <!-- PIN entry (hidden initially) -->
  <div id="userPinScreen" style="display:none; max-width:420px; margin:18px auto; text-align:center;">
    <div class="segment">
      <h3>Enter your 4-digit PIN</h3>
      <input id="userPinInput" inputmode="numeric" pattern="[0-9]*" maxlength="4" type="password" class="inputBox"
             style="width:160px; text-align:center; font-size:18px;" placeholder="••••" />
      <div style="display:flex; gap:10px; justify-content:center; margin-top:12px;">
        <button id="userPinBtn" style="background:#16a085; color:#fff;">Login</button>
        <button id="userBackBtn" style="background:#7f8c8d; color:#fff;">Back</button>
      </div>
    </div>
  </div>

  <!-- Main app screen -->
  <div id="appScreen" style="display:none;">
    <div style="text-align:right; max-width:1100px; margin:14px auto 0 auto;">
      <button id="homeBtn" style="background:#34495e; color:#fff; padding:8px 12px; border-radius:6px; font-weight:700;">Home</button>
    </div>

    <div id="mainContainer" style="max-width:1100px; margin:18px auto;">
      <!-- Left panel -->
      <div class="sidePanel" id="leftPanel">
        <img id="leftImage" src="https://raw.githubusercontent.com/nganaezechiel/cash-app-assets/main/left-placeholder.png" alt="Left Image"/>
      </div>

      <!-- center segments -->
      <div class="segmentWrapper">
        <div class="segment" id="segment1">
          <h3>Accounts</h3>
          <div id="accountList" style="display:flex; flex-direction:column;"></div>

          <div id="adminControls" style="display:none; margin-top:14px;">
            <h4 style="color:#fff;">Admin Controls</h4>
            <input id="accFullName" class="inputBox" placeholder="Full name (required)" />
            <input id="accAlias" class="inputBox" placeholder="Alias (shown to users)" />
            <input id="accAge" class="inputBox" placeholder="Age" />
            <input id="accGender" class="inputBox" placeholder="Gender" />
            <input id="accPin" class="inputBox" placeholder="4-digit PIN (required)" maxlength="4" inputmode="numeric" />
            <div style="display:flex; gap:8px;">
              <button id="createAccBtn" style="background:#2980b9; color:#fff; flex:1;">Create Account</button>
              <button id="editAccBtn" style="background:#f39c12; color:#fff; flex:1;">Edit Selected</button>
            </div>
            <div style="display:flex; gap:8px; margin-top:8px;">
              <button id="deleteAccBtn" style="background:#e74c3c; color:#fff; flex:1;">Delete Selected</button>
              <button id="resetUserPinBtn" style="background:#27ae60; color:#fff; flex:1;">Reset User PIN</button>
            </div>
          </div>
        </div>

        <div class="segment" id="segment2">
          <h3>Account Details</h3>
          <div id="userRealName" style="font-size:18px; margin-bottom:8px;"></div>
          <div>Total: <strong><span id="totalMoney">0</span></strong> UGX</div>
          <input id="amountInput" class="inputBox" placeholder="Amount" type="number" />
          <input id="reasonInput" class="inputBox" placeholder="Reason / Comment" />
          <div style="display:flex; gap:8px;">
            <button id="addMoneyBtn" style="background:#27ae60; color:#fff; flex:1;">Add Money</button>
            <button id="removeMoneyBtn" style="background:#c0392b; color:#fff; flex:1;">Remove Money</button>
          </div>
          <p class="small" id="readonlyNotice">This account is read-only for users.</p>
        </div>

        <div class="segment" id="segment3">
          <h3>Transaction History</h3>
          <div class="history" id="historyList"></div>
        </div>

        <div class="segment" id="segment4">
          <h3>Bible Verse</h3>
          <div id="extraVerse"><em>"But the angel said to them, 'Do not be afraid. I bring you good news of great joy for all people...'"</em>
            <div class="small" style="margin-top:8px;">Luke 2:10-11</div>
          </div>
          <p class="small">Static verse for users.</p>
        </div>
      </div>

      <!-- Right panel -->
      <div class="sidePanel" id="rightPanel">
        <img id="rightImage" src="https://raw.githubusercontent.com/nganaezechiel/cash-app-assets/main/right-placeholder.png" alt="Right Image"/>
      </div>
    </div>
  </div>

<!-- Firebase libs -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
/* =======================
   Firebase config
   ======================= */
const firebaseConfig = {
  apiKey: "AIzaSyDbW2RuOnSr4H7Cl0_CLu99ckPbrh2y4Gw",
  authDomain: "business-app-data.firebaseapp.com",
  databaseURL: "https://business-app-data-default-rtdb.firebaseio.com",
  projectId: "business-app-data",
  storageBucket: "business-app-data.firebasestorage.app",
  messagingSenderId: "64963134720",
  appId: "1:64963134720:web:f8dd72fbe82342b1f91fe5",
  measurementId: "G-21K1R3V7SH"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* =======================
   Utility: hash string (SHA-256) -> hex
   (uses subtle crypto)
   ======================= */
async function hashStringHex(str){
  const enc = new TextEncoder().encode(str);
  const hash = await crypto.subtle.digest('SHA-256', enc);
  const arr = Array.from(new Uint8Array(hash));
  return arr.map(b => b.toString(16).padStart(2,'0')).join('');
}

/* =======================
   App state + DOM refs
   ======================= */
let mode = null;
let currentAccountKey = null;
let currentUserKey = null;
let accountsCache = {};
let currentAcctRef = null; // for detaching listeners

const welcome = document.getElementById('welcomeScreen');
const adminLogin = document.getElementById('adminLogin');
const userSelect = document.getElementById('userSelect');
const userPinScreen = document.getElementById('userPinScreen');
const appScreen = document.getElementById('appScreen');

const adminPassInput = document.getElementById('adminPassInput');
const adminLoginBtn = document.getElementById('adminLoginBtn');
const adminResetButton = document.getElementById('adminResetButton');

const accountListEl = document.getElementById('accountList');
const historyListEl = document.getElementById('historyList');
const totalMoneyEl = document.getElementById('totalMoney');
const userRealNameEl = document.getElementById('userRealName');

const accFullName = document.getElementById('accFullName');
const accAlias = document.getElementById('accAlias');
const accAge = document.getElementById('accAge');
const accGender = document.getElementById('accGender');
const accPin = document.getElementById('accPin');

const createAccBtn = document.getElementById('createAccBtn');
const editAccBtn = document.getElementById('editAccBtn');
const deleteAccBtn = document.getElementById('deleteAccBtn');
const resetUserPinBtn = document.getElementById('resetUserPinBtn');

const addMoneyBtn = document.getElementById('addMoneyBtn');
const removeMoneyBtn = document.getElementById('removeMoneyBtn');
const amountInput = document.getElementById('amountInput');
const reasonInput = document.getElementById('reasonInput');

const userAccountList = document.getElementById('userAccountList');
const userPinInput = document.getElementById('userPinInput');
const userPinBtn = document.getElementById('userPinBtn');
const userBackBtn = document.getElementById('userBackBtn');

const userCancelBtn = document.getElementById('userCancelBtn');

document.getElementById('adminBtn').onclick = ()=>{ mode='admin'; showAdminLogin(); };
document.getElementById('userBtn').onclick = ()=>{ mode='user'; showUserSelect(); };
document.getElementById('homeBtn').onclick = goHome;
userCancelBtn && (userCancelBtn.onclick = ()=>{ hideAllModals(); showWelcome(); });

/* input hygiene: only digits in PIN fields */
[ accPin, userPinInput ].forEach(inp=>{
  if(!inp) return;
  inp.addEventListener('input', ()=> inp.value = inp.value.replace(/\D/g,'').slice(0,4));
});

/* =======================
   PANEL IMAGES loader (optional)
   reads panelImages.left/right, fallback to repo
   ======================= */
async function loadPanels(){
  try{
    const snap = await db.ref('panelImages').get();
    const data = snap.val() || {};
    document.getElementById('leftImage').src = data.left || 'https://raw.githubusercontent.com/nganaezechiel/cash-app-assets/main/left-placeholder.png';
    document.getElementById('rightImage').src = data.right || 'https://raw.githubusercontent.com/nganaezechiel/cash-app-assets/main/right-placeholder.png';
  }catch(e){
    console.warn('Panels load failed', e);
  }
}
loadPanels();

/* =======================
   Helpers: UI show/hide
   ======================= */
function hideAllModals(){
  adminLogin.style.display='none';
  userSelect.style.display='none';
  userPinScreen.style.display='none';
  appScreen.style.display='none';
  userAccountList.innerHTML='';
}
function showWelcome(){ welcome.style.display='flex'; }
function showAdminLogin(){ welcome.style.display='none'; adminLogin.style.display='block'; adminPassInput.focus(); }
function showUserSelect(){ welcome.style.display='none'; userSelect.style.display='block'; loadUserAccountList(); }
function showUserPin(){ userSelect.style.display='none'; userPinScreen.style.display='block'; userPinInput.focus(); }

/* =======================
   Admin password helpers & migration
   - admin password stored as hashed value at admin/passwordHash
   - if legacy admin/password exists (plain), we migrate it safely on first correct check
   ======================= */
async function getStoredAdminHash(){
  const snapHash = await db.ref('admin/passwordHash').get();
  if(snapHash.exists()) return snapHash.val();
  // fallback: old plain password key
  const snapPlain = await db.ref('admin/password').get();
  if(snapPlain.exists()) {
    // migrate: hash plain and store passwordHash, remove plain
    const plain = snapPlain.val();
    const h = await hashStringHex(plain);
    await db.ref('admin/passwordHash').set(h);
    await db.ref('admin/password').remove();
    console.log('Migrated admin password to passwordHash.');
    return h;
  }
  return null;
}

/* Admin login */
adminLoginBtn.onclick = async ()=>{
  try{
    const pass = (adminPassInput.value||'').trim(); adminPassInput.value='';
    if(!pass) return alert('Enter admin password');
    const storedHash = await getStoredAdminHash();
    const passHash = await hashStringHex(pass);
    if(!storedHash){
      // no password set -> create it
      await db.ref('admin/passwordHash').set(passHash);
      alert('Admin password created. You are now admin.');
      enterAdmin();
      return;
    }
    if(passHash === storedHash){
      enterAdmin();
    } else {
      alert('Wrong admin password');
    }
  }catch(e){ console.error(e); alert('Error during admin login'); }
};

/* Admin change password (requires current password) */
adminResetButton.onclick = async ()=>{
  try{
    const current = prompt('Enter current admin password:');
    if(!current) return;
    const storedHash = await getStoredAdminHash();
    const currentHash = await hashStringHex(current);
    if(storedHash && currentHash !== storedHash) return alert('Current password incorrect');
    const next = prompt('Enter new admin password:');
    if(!next) return;
    const nextHash = await hashStringHex(next);
    await db.ref('admin/passwordHash').set(nextHash);
    alert('Admin password updated.');
  }catch(e){ console.error(e); alert('Error changing password'); }
};

/* Enter admin view */
function enterAdmin(){
  hideAllModals();
  appScreen.style.display='block';
  document.getElementById('adminControls').style.display='block';
  amountInput.style.display='block';
  reasonInput.style.display='block';
  addMoneyBtn.style.display='inline-block';
  removeMoneyBtn.style.display='inline-block';
  document.getElementById('readonlyNotice').style.display='none';
  loadAccountList();
}

/* =======================
   USER FLOW
   - loadUserAccountList shows accounts for selection
   - on selecting account, userPinScreen appears
   - pin is compared to hashed pin at accounts/{id}/pinHash
   - migration: if legacy plain pin exists at accounts/{id}/pin -> we accept and migrate to pinHash
   ======================= */
async function loadUserAccountList(){
  try{
    userAccountList.innerHTML = '';
    const snap = await db.ref('accounts').get();
    if(!snap.exists()){
      userAccountList.innerHTML = '<div class="small">No accounts available.</div>';
      return;
    }
    snap.forEach(child=>{
      const data = child.val() || {};
      const alias = data.alias || data.fullName || ('acct-'+child.key.slice(-4));
      const div = document.createElement('div');
      div.className = 'accountItem';
      div.innerText = alias;
      div.onclick = ()=>{ currentAccountKey = child.key; showUserPin(); };
      userAccountList.appendChild(div);
    });
  }catch(e){ console.error(e); alert('Failed to load accounts'); }
}

userBackBtn.onclick = ()=>{ userPinScreen.style.display='none'; userSelect.style.display='block'; }
userPinBtn.onclick = userPinHandler;

async function userPinHandler(){
  try{
    const pin = (userPinInput.value||'').trim(); userPinInput.value='';
    if(!pin) return alert('Enter PIN');
    if(!currentAccountKey) return alert('No account selected');
    const accRef = db.ref('accounts/'+currentAccountKey);
    const snap = await accRef.get();
    if(!snap.exists()) return alert('Account not found');
    const acc = snap.val() || {};

    // migration: if legacy 'pin' (plain) exists, convert to pinHash
    if(acc.pin && !acc.pinHash){
      // store hashed and remove plain pin
      const legacyPin = acc.pin;
      const legacyHash = await hashStringHex(legacyPin);
      await accRef.update({ pinHash: legacyHash });
      await accRef.child('pin').remove();
      acc.pinHash = legacyHash;
      console.log('Migrated pin -> pinHash for account', currentAccountKey);
    }

    if(!acc.pinHash) return alert('Account PIN not set. Contact admin.');

    const providedHash = await hashStringHex(pin);
    if(providedHash === acc.pinHash){
      currentUserKey = currentAccountKey;
      enterUserView();
    } else {
      alert('Incorrect PIN');
    }
  }catch(e){ console.error(e); alert('Error during PIN check'); }
}

/* Enter user view */
function enterUserView(){
  hideAllModals();
  appScreen.style.display='block';
  document.getElementById('adminControls').style.display='none';
  amountInput.style.display='none';
  reasonInput.style.display='none';
  addMoneyBtn.style.display='none';
  removeMoneyBtn.style.display='none';
  document.getElementById('readonlyNotice').style.display='block';
  loadAccountList(); // so account list highlights available accounts
  loadAccountDetails(currentUserKey);
}

/* =======================
   Account normalization + migration
   - we standardize on fields:
     fullName, alias, age, gender, pinHash (optional), balance (number), history (object)
   ======================= */
function normalizeAccount(key, raw){
  const a = raw || {};
  return {
    fullName: a.fullName || a.fullname || 'Unknown',
    alias: a.alias || a.fullName || ('acct-'+key.slice(-4)),
    age: a.age || '',
    gender: a.gender || '',
    pinHash: a.pinHash || null, // hashed PIN
    balance: (typeof a.balance !== 'undefined') ? Number(a.balance) : 0,
    history: a.history || {}
  };
}

/* optional migration to set balance/history/pinHash if missing */
async function migrateAccountIfNeeded(key, raw){
  const updates = {};
  if(!raw) raw = {};
  if(typeof raw.balance === 'undefined' && typeof raw.total !== 'undefined') updates.balance = Number(raw.total);
  if(!raw.history && raw.history === undefined) updates.history = raw.history || {};
  // migrate plain pin -> pinHash
  if(raw.pin && !raw.pinHash){
    const hashed = await hashStringHex(raw.pin);
    updates.pinHash = hashed;
    updates.pin = null;
  }
  if(Object.keys(updates).length > 0){
    try{
      await db.ref('accounts/'+key).update(updates);
      console.log('Migrated account', key, 'updated', updates);
    }catch(e){ console.warn('Migration failed for', key, e); }
  }
}

/* =======================
   Load account list (admin main view)
   - caches accounts in accountsCache
   ======================= */
async function loadAccountList(){
  try{
    accountListEl.innerHTML = '';
    accountsCache = {};
    const snap = await db.ref('accounts').get();
    if(!snap.exists()){
      accountListEl.innerHTML = '<div class="small">No accounts yet.</div>';
      return;
    }
    // iterate and migrate/check
    const promises = [];
    snap.forEach(child=>{
      const key = child.key;
      const raw = child.val() || {};
      // schedule migration
      promises.push(migrateAccountIfNeeded(key, raw).catch(()=>{}));
    });
    await Promise.all(promises);

    // fetch again (ensure migrations applied)
    const snap2 = await db.ref('accounts').get();
    snap2.forEach(child=>{
      const key = child.key;
      const raw = child.val() || {};
      const a = normalizeAccount(key, raw);
      accountsCache[key] = a;
      const div = document.createElement('div');
      div.className = 'accountItem';
      div.innerText = a.alias + (a.fullName ? (' - ' + a.fullName) : '');
      div.onclick = ()=>{
        currentAccountKey = key;
        document.querySelectorAll('#accountList .accountItem').forEach(el=>el.classList.remove('selected'));
        div.classList.add('selected');
        loadAccountDetails(key);
      };
      accountListEl.appendChild(div);
    });
  }catch(e){ console.error('loadAccountList error', e); accountListEl.innerHTML = '<div class="small">Failed to load accounts.</div>'; }
}

/* =======================
   Load a specific account's details and attach listeners
   - ensures previous listeners removed
   ======================= */
function clearCurrentListeners(){
  if(currentAcctRef){
    try{
      currentAcctRef.child('balance').off();
      currentAcctRef.child('history').off();
    }catch(e){ /* ignore */ }
    currentAcctRef = null;
  }
}

async function loadAccountDetails(key){
  if(!key) return;
  try{
    clearCurrentListeners();
    const acctRef = db.ref('accounts/'+key);
    currentAcctRef = acctRef;
    acctRef.child('balance').on('value', snap => {
      const val = snap.val();
      totalMoneyEl.innerText = (val !== null && val !== undefined) ? val : 0;
    });
    // initial load
    const snap = await acctRef.get();
    const raw = snap.val() || {};
    const a = normalizeAccount(key, raw);
    userRealNameEl.innerText = 'Name: ' + a.fullName;
    // history listener
    acctRef.child('history').on('value', s=>{
      const val = s.val() || {};
      historyListEl.innerHTML = '';
      // convert object -> array
      const entries = Object.values(val).sort((x,y)=>( (y.timestamp||0) - (x.timestamp||0) ));
      entries.forEach(it=>{
        const div = document.createElement('div');
        div.className = 'history-item ' + (it.type === 'add' ? 'add' : 'remove');
        const comment = it.comment || it.reason || '';
        const ts = it.timestamp ? new Date(it.timestamp).toLocaleString() : '';
        div.innerHTML = `<strong>${it.type === 'add' ? '+' : '-'} ${it.amount} UGX</strong><div class='small'>${comment}</div><div class='small'>${ts}</div>`;
        historyListEl.appendChild(div);
      });
    });
  }catch(e){ console.error(e); alert('Failed to load account details'); }
}

/* =======================
   Admin CRUD
   - create/edit/delete, reset pin
   - store pinHash rather than plain pin
   ======================= */
createAccBtn.onclick = async ()=>{
  try{
    const fullName = (accFullName.value||'').trim();
    const alias = (accAlias.value||'').trim() || fullName;
    const age = (accAge.value||'').trim();
    const gender = (accGender.value||'').trim();
    const pin = (accPin.value||'').trim();
    if(!fullName || !pin) return alert('Full name and PIN required');
    if(!/^\d{4}$/.test(pin)) return alert('PIN must be 4 digits');

    const pinHash = await hashStringHex(pin);
    const newRef = db.ref('accounts').push();
    await newRef.set({
      fullName,
      alias,
      age,
      gender,
      pinHash,
      balance: 0,
      history: {}
    });
    // clear inputs
    accFullName.value=''; accAlias.value=''; accAge.value=''; accGender.value=''; accPin.value='';
    alert('Account created');
    await loadAccountList();
  }catch(e){ console.error(e); alert('Failed to create account'); }
};

editAccBtn.onclick = async ()=>{
  try{
    if(!currentAccountKey) return alert('Select an account first');
    const data = {};
    if(accFullName.value) data.fullName = accFullName.value;
    if(accAlias.value) data.alias = accAlias.value;
    if(accAge.value) data.age = accAge.value;
    if(accGender.value) data.gender = accGender.value;
    if(accPin.value){
      const p = accPin.value.trim();
      if(!/^\d{4}$/.test(p)) return alert('PIN must be 4 digits');
      data.pinHash = await hashStringHex(p);
    }
    if(Object.keys(data).length === 0) return alert('No changes entered');
    await db.ref('accounts/'+currentAccountKey).update(data);
    alert('Account updated');
    accFullName.value=''; accAlias.value=''; accAge.value=''; accGender.value=''; accPin.value='';
    await loadAccountList();
  }catch(e){ console.error(e); alert('Failed to edit account'); }
};

deleteAccBtn.onclick = async ()=>{
  try{
    if(!currentAccountKey) return alert('Select an account');
    const ok = confirm('Delete this account? This cannot be undone.');
    if(!ok) return;
    await db.ref('accounts/'+currentAccountKey).remove();
    currentAccountKey = null;
    alert('Account deleted');
    await loadAccountList();
    clearCurrentListeners();
    historyListEl.innerHTML = '';
    userRealNameEl.innerText = '';
    totalMoneyEl.innerText = '0';
  }catch(e){ console.error(e); alert('Failed to delete account'); }
};

resetUserPinBtn.onclick = async ()=>{
  try{
    if(!currentAccountKey) return alert('Select an account');
    const newPin = prompt('Enter new 4-digit PIN for this user:');
    if(!newPin) return;
    if(!/^\d{4}$/.test(newPin)) return alert('PIN must be 4 digits');
    const hash = await hashStringHex(newPin);
    await db.ref('accounts/'+currentAccountKey+'/pinHash').set(hash);
    alert('User PIN reset.');
  }catch(e){ console.error(e); alert('Failed to reset user PIN'); }
};

/* =======================
   Money operations
   - admin updates balance + push history with timestamp
   - history stored as objects with timestamp
   ======================= */
addMoneyBtn.onclick = async ()=>{
  try{
    if(!currentAccountKey) return alert('Select account');
    const amt = Number(amountInput.value);
    if(!amt || isNaN(amt)) return alert('Enter valid amount');
    const reason = reasonInput.value||'';
    const acctRef = db.ref('accounts/'+currentAccountKey);
    const snap = await acctRef.child('balance').get();
    let bal = Number(snap.val() || 0);
    bal += amt;
    await acctRef.update({ balance: bal });
    await acctRef.child('history').push({
      type: 'add',
      amount: amt,
      reason,
      comment: reason,
      timestamp: Date.now()
    });
    amountInput.value=''; reasonInput.value='';
    await loadAccountDetails(currentAccountKey);
  }catch(e){ console.error(e); alert('Failed to add money'); }
};

removeMoneyBtn.onclick = async ()=>{
  try{
    if(!currentAccountKey) return alert('Select account');
    const amt = Number(amountInput.value);
    if(!amt || isNaN(amt)) return alert('Enter valid amount');
    const reason = reasonInput.value||'';
    const acctRef = db.ref('accounts/'+currentAccountKey);
    const snap = await acctRef.child('balance').get();
    let bal = Number(snap.val() || 0);
    if(bal - amt < 0) return alert('Insufficient balance');
    bal -= amt;
    await acctRef.update({ balance: bal });
    await acctRef.child('history').push({
      type: 'remove',
      amount: amt,
      reason,
      comment: reason,
      timestamp: Date.now()
    });
    amountInput.value=''; reasonInput.value='';
    await loadAccountDetails(currentAccountKey);
  }catch(e){ console.error(e); alert('Failed to remove money'); }
};

/* =======================
   Export CSV (kept as before)
   ======================= */
function exportAccountToCSV(accountKey){
  if(!accountKey) return alert('No account selected');
  db.ref('accounts/'+accountKey).get().then(snap=>{
    const acc=snap.val(); if(!acc) return alert('Account not found');
    let csvContent='Account Details\n';
    csvContent+=`Full Name,${acc.fullName||''}\n`;
    csvContent+=`Alias,${acc.alias||''}\n`;
    csvContent+=`Age,${acc.age||''}\n`;
    csvContent+=`Gender,${acc.gender||''}\n`;
    csvContent+=`Balance,${acc.balance||0}\n\n`;
    csvContent+='Transaction History\nType,Amount,Reason/Comment,Timestamp\n';
    const history=acc.history||{};
    const entries=Object.values(history).sort((a,b)=>(a.timestamp||0)-(b.timestamp||0));
    entries.forEach(e=>{
      const ts=e.timestamp?new Date(e.timestamp).toLocaleString():'';
      const comment=e.comment||e.reason||'';
      csvContent+=`${e.type||''},${e.amount||''},"${(comment+'').replace(/"/g,'""')}",${ts}\n`;
    });
    const blob=new Blob([csvContent], {type:'text/csv;charset=utf-8;'});
    const link=document.createElement('a');
    link.href=URL.createObjectURL(blob); link.download=`CashApp_Account_${acc.alias||accountKey}.csv`;
    document.body.appendChild(link); link.click(); document.body.removeChild(link);
  }).catch(e=>{ console.error(e); alert('Export failed'); });
}

/* Add export button under accounts */
(function addExportButton(){
  try{
    const exportBtn=document.createElement('button');
    exportBtn.innerText='Export Account';
    exportBtn.style.background='#8e44ad';
    exportBtn.style.color='#fff';
    exportBtn.style.marginTop='8px';
    exportBtn.onclick=()=>{ if(mode==='admin') exportAccountToCSV(currentAccountKey); else if(mode==='user') exportAccountToCSV(currentUserKey); };
    document.getElementById('segment1').appendChild(exportBtn);
  }catch(e){ /* ignore */ }
})();

/* =======================
   Home / navigation helpers
   ======================= */
function goHome(){
  hideAllModals();
  showWelcome();
  currentAccountKey = null;
  currentUserKey = null;
  userPinInput && (userPinInput.value='');
  document.querySelectorAll('.accountItem').forEach(el=>el.classList.remove('selected'));
  clearCurrentListeners();
}

/* initialize: show welcome */
showWelcome();

</script>
</body>
</html>
