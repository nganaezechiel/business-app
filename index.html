// ---------------- CSV Export ----------------
function convertToCSV(objArray) {
    const array = Array.isArray(objArray) ? objArray : Object.values(objArray);
    if(array.length === 0) return '';
    const keys = Object.keys(array[0]);
    const csvRows = [];
    csvRows.push(keys.join(',')); // header
    array.forEach(item => {
        const row = keys.map(k => {
            let val = item[k] || '';
            if(typeof val === 'string') val = val.replace(/"/g, '""'); // escape quotes
            return `"${val}"`;
        });
        csvRows.push(row.join(','));
    });
    return csvRows.join('\n');
}

function downloadCSV(filename, csvContent) {
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    link.setAttribute('download', filename);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

// ---------------- Export Selected Account ----------------
document.getElementById('exportCSVBtn').onclick = async () => {
    if(!currentAccountKey) return alert('Select an account first');
    const snap = await db.ref('accounts/' + currentAccountKey).get();
    if(!snap.exists()) return alert('No data for this account');
    const data = snap.val();
    // flatten account + history
    const history = data.history || {};
    const csvData = Object.entries(history).map(([key, entry]) => ({
        type: entry.type,
        amount: entry.amount,
        reason: entry.comment || entry.reason || '',
        timestamp: entry.timestamp ? new Date(entry.timestamp).toLocaleString() : '',
        accountAlias: data.alias || '',
        fullName: data.fullName || ''
    }));
    const csv = convertToCSV(csvData);
    downloadCSV(`${data.alias || currentAccountKey}_history.csv`, csv);
};

// ---------------- Export All Accounts ----------------
document.getElementById('exportAllCSVBtn').onclick = async () => {
    const snap = await db.ref('accounts').get();
    if(!snap.exists()) return alert('No accounts found');
    const allData = [];
    snap.forEach(child => {
        const data = child.val();
        const history = data.history || {};
        Object.entries(history).forEach(([key, entry]) => {
            allData.push({
                type: entry.type,
                amount: entry.amount,
                reason: entry.comment || entry.reason || '',
                timestamp: entry.timestamp ? new Date(entry.timestamp).toLocaleString() : '',
                accountAlias: data.alias || '',
                fullName: data.fullName || ''
            });
        });
    });
    const csv = convertToCSV(allData);
    downloadCSV(`all_accounts_history.csv`, csv);
};
