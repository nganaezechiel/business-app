<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>$Cash App</title>
<link href="https://fonts.googleapis.com/css2?family=Luckiest+Guy&family=Montserrat:wght@400;700&display=swap" rel="stylesheet">
<style>
* { margin:0; padding:0; box-sizing:border-box; font-family:'Montserrat', sans-serif; }
body {
  background: url('https://raw.githubusercontent.com/nganaezechiel/cash-app-assets/e73e05fe79593a21fce4b2f83e15f91a437658f9/background.PNG') no-repeat center center fixed;
  background-size: cover;
}

/* Title */
#titleBar { font-family:'Luckiest Guy', cursive; font-size:48px; color:#ffeb3b; text-shadow:2px 2px 6px #000; text-align:center; margin:20px 0; animation:floatLogo 2s ease-in-out infinite alternate;}
@keyframes floatLogo {0%{transform:translateY(0px);}100%{transform:translateY(-10px);}}

/* Main container for panels + center segments */
#mainContainer { display:flex; gap:15px; width:100%; min-height:75vh; justify-content:center; padding-bottom:40px; }
.sidePanel { flex:0.6; border-radius:12px; background:rgba(255,255,255,0.06); backdrop-filter: blur(6px); display:flex; justify-content:center; align-items:center; overflow:hidden; min-height:400px; box-shadow:0 6px 18px rgba(0,0,0,0.35);}
.sidePanel img { max-width:100%; max-height:100%; object-fit:contain; border-radius:10px; transition:0.3s ease; }
.sidePanel img:hover { transform:scale(1.05); }

.segmentWrapper { flex:2; display:flex; flex-direction:column; gap:20px; max-width:550px; }

/* Segment styles */
.segment { flex:1; background:rgba(255,255,255,0.08); border-radius:12px; padding:15px; backdrop-filter: blur(6px); overflow-y:auto; box-shadow:0 6px 18px rgba(0,0,0,0.35); }

button { padding:10px; border:none; border-radius:8px; cursor:pointer; margin-top:10px; font-weight:700; transition:0.2s; }
button:hover { opacity:0.85; transform:translateY(-2px); }
.inputBox { width:100%; padding:10px; margin-top:10px; border-radius:8px; border:none; font-size:15px; }

.accountItem { background:rgba(255,255,255,0.06); padding:10px; border-radius:8px; margin-top:8px; cursor:pointer; }
.accountItem.selected { background:rgba(255,255,255,0.18); color:#000; font-weight:700; }

.history { max-height:60vh; overflow-y:auto; padding:8px; }
.history-item { padding:10px; margin-bottom:8px; border-radius:8px; color:#fff; }
.history-item.add { background:#2a8f4a; }
.history-item.remove { background:#b33a3a; }

#extraVerse { font-size:16px; line-height:1.4; text-align:center; }
.small { font-size:12px; opacity:0.9; }
#readonlyNotice { text-align:center; margin-top:6px; color:#f0f0f0; font-style:italic; }

/* Welcome Box */
#welcomeBox { background:rgba(0,0,0,0.35); padding:25px; border-radius:15px; text-align:center; max-width:320px; margin:20px auto; box-shadow:0 6px 20px rgba(0,0,0,0.4); }
#welcomeBox button { width:140px; margin:10px; }

/* Responsive */
@media(max-width:1050px){ 
  #mainContainer{flex-direction:column; align-items:center;} 
  .sidePanel{width:90%; margin-bottom:12px; flex:unset;}
  .segmentWrapper{width:90%;}
}
</style>
</head>
<body>

<div id="titleBar">$Cash App</div>

<!-- Welcome / Login -->
<div id="welcomeScreen" style="height:80vh; display:flex; justify-content:center; align-items:center; flex-direction:column;">
  <p style="text-align:center; font-size:18px; color:#fff; margin-bottom:20px;">
    Keep track of your savings, transactions, and account details easily.
  </p>
  
  <div id="welcomeBox" style="background:rgba(0,0,0,0.6); padding:30px; border-radius:15px; text-align:center; box-shadow:0 6px 20px rgba(0,0,0,0.4); min-width:280px;">
    <h3 style="color:#fff; margin-bottom:10px;">Who are you?</h3>
    <p style="color:#ccc; font-size:14px; margin-bottom:20px;">Please select your login type:</p>
    
    <button id="adminBtn" style="background:#2c3e50; color:#fff; width:120px; padding:10px; margin:10px; border-radius:8px;">Admin</button>
    <button id="userBtn" style="background:#16a085; color:#fff; width:120px; padding:10px; margin:10px; border-radius:8px;">User</button>
  </div>
</div>

<!-- App Screen -->
<div id="appScreen" style="display:none;">
<div id="mainContainer">

  <!-- Left Panel -->
  <div class="sidePanel" id="leftPanel">
    <img id="leftImage" src="https://raw.githubusercontent.com/nganaezechiel/cash-app-assets/main/left-placeholder.png" alt="Left Image"/>
  </div>

  <!-- Center Segments -->
  <div class="segmentWrapper">
    <!-- Segment 1: Accounts -->
    <div class="segment" id="segment1">
      <h3>Accounts</h3>
      <div id="accountList"></div>
      <div id="adminControls" style="display:none; margin-top:14px;">
        <h4>Admin Controls</h4>
        <input id="accFullName" class="inputBox" placeholder="Full name (required)" />
        <input id="accAlias" class="inputBox" placeholder="Alias (shown to users)" />
        <input id="accAge" class="inputBox" placeholder="Age" />
        <input id="accGender" class="inputBox" placeholder="Gender" />
        <input id="accPin" class="inputBox" placeholder="4-digit PIN (required)" maxlength="4" />
        <div style="display:flex; gap:8px;">
          <button id="createAccBtn" style="background:#2980b9; color:#fff; flex:1;">Create Account</button>
          <button id="editAccBtn" style="background:#f39c12; color:#fff; flex:1;">Edit Selected</button>
        </div>
        <div style="display:flex; gap:8px; margin-top:8px;">
          <button id="deleteAccBtn" style="background:#e74c3c; color:#fff; flex:1;">Delete Selected</button>
          <button id="resetUserPinBtn" style="background:#27ae60; color:#fff; flex:1;">Reset User PIN</button>
        </div>
      </div>
    </div>

    <!-- Segment 2: Account Details -->
    <div class="segment" id="segment2">
      <h3>Account Details</h3>
      <div id="userRealName" style="font-size:18px; margin-bottom:8px; color:#fff;"></div>
      <div>Total: <strong><span id="totalMoney">0</span></strong> UGX</div>
      <input id="amountInput" class="inputBox" placeholder="Amount" type="number" />
      <input id="reasonInput" class="inputBox" placeholder="Reason / Comment" />
      <div style="display:flex; gap:8px;">
        <button id="addMoneyBtn" style="background:#27ae60; color:#fff; flex:1;">Add Money</button>
        <button id="removeMoneyBtn" style="background:#c0392b; color:#fff; flex:1;">Remove Money</button>
      </div>
      <p class="small" id="readonlyNotice">This account is read-only for users.</p>
    </div>

    <!-- Segment 3: Transaction History -->
    <div class="segment" id="segment3">
      <h3>Transaction History</h3>
      <div class="history" id="historyList"></div>
    </div>

    <!-- Segment 4: Bible Verse -->
    <div class="segment" id="segment4">
      <h3>Bible Verse</h3>
      <div id="extraVerse"><em>"But the angel said to them, 'Do not be afraid. I bring you good news of great joy for all people. Today in the town of David a Savior has been born to you; he is the Messiah, the Lord.'"</em><div class="small" style="margin-top:8px;">Luke 2:10-11</div></div>
      <p class="small">Static verse for users.</p>
    </div>
  </div>

  <!-- Right Panel -->
  <div class="sidePanel" id="rightPanel">
    <img id="rightImage" src="https://raw.githubusercontent.com/nganaezechiel/cash-app-assets/main/right-placeholder.png" alt="Right Image"/>
  </div>

</div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script>
// ---------------- Firebase ----------------
const firebaseConfig = {
  apiKey: "AIzaSyDbW2RuOnSr4H7Cl0_CLu99ckPbrh2y4Gw",
  authDomain: "business-app-data.firebaseapp.com",
  databaseURL: "https://business-app-data-default-rtdb.firebaseio.com",
  projectId: "business-app-data",
  storageBucket: "business-app-data.firebasestorage.app",
  messagingSenderId: "64963134720",
  appId: "1:64963134720:web:f8dd72fbe82342b1f91fe5",
  measurementId: "G-21K1R3V7SH"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// ---------------- Panels ----------------
async function loadPanels(){
  const snap = await db.ref('panelImages').get();
  const data = snap.val()||{};
  document.getElementById('leftImage').src = data.left || 'https://raw.githubusercontent.com/nganaezechiel/cash-app-assets/main/left-placeholder.png';
  document.getElementById('rightImage').src = data.right || 'https://raw.githubusercontent.com/nganaezechiel/cash-app-assets/main/right-placeholder.png';
}
loadPanels();

// ---------------- App state ----------------
let mode=null; let currentAccountKey=null; let currentUserKey=null; let accountsCache={};

// Elements
const welcome=document.getElementById('welcomeScreen');
const adminLogin=document.getElementById('adminLogin');
const userSelect=document.getElementById('userSelect');
const userPinScreen=document.getElementById('userPinScreen');
const appScreen=document.getElementById('appScreen');

const adminPassInput=document.getElementById('adminPassInput');
const adminLoginBtn=document.getElementById('adminLoginBtn');
const adminResetButton=document.getElementById('adminResetButton');

const accountListEl=document.getElementById('accountList');
const historyListEl=document.getElementById('historyList');
const totalMoneyEl=document.getElementById('totalMoney');
const userRealNameEl=document.getElementById('userRealName');

const accFullName=document.getElementById('accFullName');
const accAlias=document.getElementById('accAlias');
const accAge=document.getElementById('accAge');
const accGender=document.getElementById('accGender');
const accPin=document.getElementById('accPin');

const createAccBtn=document.getElementById('createAccBtn');
const editAccBtn=document.getElementById('editAccBtn');
const deleteAccBtn=document.getElementById('deleteAccBtn');
const resetUserPinBtn=document.getElementById('resetUserPinBtn');

const addMoneyBtn=document.getElementById('addMoneyBtn');
const removeMoneyBtn=document.getElementById('removeMoneyBtn');
const amountInput=document.getElementById('amountInput');
const reasonInput=document.getElementById('reasonInput');

const userAccountList=document.getElementById('userAccountList');
const userPinInput=document.getElementById('userPinInput');
const userPinBtn=document.getElementById('userPinBtn');
const userBackBtn=document.getElementById('userBackBtn');
const readonlyNotice=document.getElementById('readonlyNotice');

document.getElementById('adminBtn').onclick = ()=>{ mode='admin'; welcome.style.display='none'; showAdminLogin(); };
document.getElementById('userBtn').onclick = ()=>{ mode='user'; welcome.style.display='none'; showUserSelect(); };

// ---------------- Functions ----------------
function showAdminLogin(){
  let adminDiv=document.getElementById('adminLogin');
  if(!adminDiv){
    adminDiv=document.createElement('div');
    adminDiv.id='adminLogin';
    adminDiv.innerHTML=`<h3>Admin Login</h3>
    <input id="adminPassInput" type="password" class="inputBox" placeholder="Enter admin password" />
    <div>
      <button id="adminLoginBtn" style="background:#34495e; color:#fff;">Login</button>
      <button id="adminResetButton" style="background:#9b59b6; color:#fff; margin-left:8px;">Reset Admin Password</button>
    </div>
    <p class="small">If no admin password is set yet, entering one will create it.</p>`;
    document.body.appendChild(adminDiv);
    document.getElementById('adminLoginBtn').onclick = adminLoginHandler;
    document.getElementById('adminResetButton').onclick = adminResetHandler;
  }
  adminDiv.style.display='block';
}

function showUserSelect(){
  let userDiv=document.getElementById('userSelect');
  if(!userDiv){
    userDiv=document.createElement('div');
    userDiv.id='userSelect';
    userDiv.innerHTML=`<h3>Select your account (alias)</h3><div id="userAccountList"></div>`;
    document.body.appendChild(userDiv);
  }
  userDiv.style.display='block';
  loadUserAccountList();
}

// ---------------- Admin Login ----------------
async function adminLoginHandler(){
  const pass=(document.getElementById('adminPassInput').value||'').trim();
  document.getElementById('adminPassInput').value='';
  if(!pass) return alert('Enter a password');
  const snap = await db.ref('admin/password').get();
  if(!snap.exists()){ await db.ref('admin/password').set(pass); alert('Admin password created'); enterAdmin(); return; }
  if(snap.val()===pass){ enterAdmin(); } else alert('Wrong admin password');
}
async function adminResetHandler(){
  const ok=confirm('Reset admin password?'); if(!ok) return;
  const newPass=prompt('Enter new admin password:'); if(!newPass) return;
  await db.ref('admin/password').set(newPass); alert('Admin password updated');
}
function enterAdmin(){
  document.getElementById('adminLogin').style.display='none';
  appScreen.style.display='block';
  document.getElementById('adminControls').style.display='block';
  amountInput.style.display='block'; reasonInput.style.display='block';
  addMoneyBtn.style.display='inline-block'; removeMoneyBtn.style.display='inline-block';
  readonlyNotice.style.display='none';
  loadAccountList();
}

// ---------------- User Login ----------------
async function loadUserAccountList(){
  const snap = await db.ref('accounts').get();
  userAccountList.innerHTML='';
  snap.forEach(child=>{
    const div=document.createElement('div'); div.className='accountItem'; div.innerText=child.val().alias||('acct-'+child.key.slice(-4));
    div.onclick=()=>{ currentAccountKey=child.key; showUserPinScreen(); };
    userAccountList.appendChild(div);
  });
}
function showUserPinScreen(){ 
  userSelect.style.display='none'; 
  let userDiv=document.getElementById('userPinScreen');
  if(!userDiv){
    userDiv=document.createElement('div');
    userDiv.id='userPinScreen';
    userDiv.innerHTML=`<h3>Enter your 4-digit PIN</h3>
    <input id="userPinInput" type="password" maxlength="4" class="inputBox" style="width:160px; text-align:center; font-size:18px;" />
    <div>
      <button id="userPinBtn" style="background:#16a085; color:#fff;">Login</button>
      <button id="userBackBtn" style="background:#7f8c8d; color:#fff; margin-left:8px;">Back</button>
    </div>`;
    document.body.appendChild(userDiv);
    document.getElementById('userPinBtn').onclick=userPinHandler;
    document.getElementById('userBackBtn').onclick=()=>{ userDiv.style.display='none'; userSelect.style.display='block'; };
  }
  userDiv.style.display='block';
}
async function userPinHandler(){
  const pin=(document.getElementById('userPinInput').value||'').trim();
  document.getElementById('userPinInput').value='';
  if(!pin) return alert('Enter PIN');
  const snap = await db.ref('accounts/'+currentAccountKey+'/pin').get();
  if(!snap.exists()) return alert('Account pin not set');
  if(snap.val()===pin){ currentUserKey=currentAccountKey; enterUserView(); }
  else alert('Incorrect PIN');
}
async function enterUserView(){
  document.getElementById('userPinScreen').style.display='none'; 
  appScreen.style.display='block';
  document.getElementById('adminControls').style.display='none';
  amountInput.style.display='none'; 
  reasonInput.style.display='none';
  addMoneyBtn.style.display='none'; 
  removeMoneyBtn.style.display='none';
  readonlyNotice.style.display='block';

  // Load only the current user's account into cache
  const snap = await db.ref('accounts/' + currentUserKey).get();
  const acc = normalizeAccount(currentUserKey, snap.val());
  accountsCache = {};
  accountsCache[currentUserKey] = acc;

  loadAccountDetails(currentUserKey);

  // Show only the logged-in user's alias in the accounts panel
  accountListEl.innerHTML = '';
  const div = document.createElement('div');
  div.className = 'accountItem selected';
  div.innerText = acc.alias;
  accountListEl.appendChild(div);
}

// ---------------- Accounts ----------------
function normalizeAccount(key, raw){
  const a=raw||{};
  return { fullName: a.fullName||a.fullname||'Unknown', alias: a.alias||('acct-'+key.slice(-4)), age:a.age||'', gender:a.gender||'', pin:a.pin||'', total:parseFloat(a.total||0), history:a.history||[] };
}
async function loadAccountList(){
  const snap=await db.ref('accounts').get(); accountsCache={};
  accountListEl.innerHTML='';
  snap.forEach(child=>{
    const acc=normalizeAccount(child.key, child.val()); accountsCache[child.key]=acc;
    const div=document.createElement('div'); div.className='accountItem'; div.innerText=acc.alias;
    div.onclick=()=>{ currentAccountKey=child.key; selectAccount(div); loadAccountDetails(child.key); };
    accountListEl.appendChild(div);
  });
}
function selectAccount(div){
  document.querySelectorAll('.accountItem').forEach(d=>d.classList.remove('selected')); div.classList.add('selected');
}
async function loadAccountDetails(key){
  const acc=accountsCache[key]; if(!acc) return;
  userRealNameEl.innerText=acc.fullName; totalMoneyEl.innerText=acc.total;
  historyListEl.innerHTML=''; acc.history.forEach(h=>{
    const div=document.createElement('div'); div.className='history-item '+(h.type||'add'); div.innerText=`${h.type==='remove'?'-':'+'}${h.amount} UGX | ${h.reason||''} | ${h.date||''}`; historyListEl.appendChild(div);
  });
}

// ---------------- Admin CRUD ----------------
createAccBtn.onclick=async()=>{
  if(!accFullName.value.trim()||!accPin.value.trim()) return alert('Fullname and PIN required');
  const newKey=db.ref('accounts').push().key;
  const data={ fullName:accFullName.value, alias:accAlias.value||accFullName.value, age:accAge.value, gender:accGender.value, pin:accPin.value, total:0, history:[] };
  await db.ref('accounts/'+newKey).set(data); accFullName.value=''; accAlias.value=''; accAge.value=''; accGender.value=''; accPin.value=''; loadAccountList();
};
editAccBtn.onclick=async()=>{
  if(!currentAccountKey) return alert('Select account first');
  const data={ fullName:accFullName.value||accountsCache[currentAccountKey].fullName, alias:accAlias.value||accountsCache[currentAccountKey].alias, age:accAge.value||accountsCache[currentAccountKey].age, gender:accGender.value||accountsCache[currentAccountKey].gender, pin:accPin.value||accountsCache[currentAccountKey].pin };
  await db.ref('accounts/'+currentAccountKey).update(data); loadAccountList();
};
deleteAccBtn.onclick=async()=>{ if(!currentAccountKey) return alert('Select account'); const ok=confirm('Delete this account?'); if(!ok) return; await db.ref('accounts/'+currentAccountKey).remove(); loadAccountList(); }
resetUserPinBtn.onclick=async()=>{ if(!currentAccountKey) return alert('Select account'); const newPin=prompt('Enter new PIN'); if(!newPin) return; await db.ref('accounts/'+currentAccountKey+'/pin').set(newPin); alert('User PIN reset'); }

// ---------------- Money ----------------
addMoneyBtn.onclick=async()=>{
  if(!currentAccountKey) return alert('Select account'); const amt=parseFloat(amountInput.value); if(isNaN(amt)) return alert('Invalid amount'); const reason=reasonInput.value||'';
  const acc=accountsCache[currentAccountKey]; acc.total+=amt; acc.history.push({ type:'add', amount:amt, reason, date:new Date().toLocaleString() });
  await db.ref('accounts/'+currentAccountKey).update({ total:acc.total, history:acc.history }); loadAccountDetails(currentAccountKey);
  amountInput.value=''; reasonInput.value='';
};
removeMoneyBtn.onclick=async()=>{
  if(!currentAccountKey) return alert('Select account'); const amt=parseFloat(amountInput.value); if(isNaN(amt)) return alert('Invalid amount'); const reason=reasonInput.value||'';
  const acc=accountsCache[currentAccountKey]; acc.total-=amt; acc.history.push({ type:'remove', amount:amt, reason, date:new Date().toLocaleString() });
  await db.ref('accounts/'+currentAccountKey).update({ total:acc.total, history:acc.history }); loadAccountDetails(currentAccountKey);
  amountInput.value=''; reasonInput.value='';
};
</script>
</body>
</html>
