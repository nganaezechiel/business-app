<!-- Full integrated HTML+JS for Cash App with admin/user system, account creation, PIN/password reset, multi-segment UI, migration and edit tools -->
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Cash App</title>
<style>
/* Basic reset */
* { margin:0; padding:0; box-sizing:border-box; font-family:Arial, Helvetica, sans-serif; }
body {
  background: linear-gradient(135deg, #ff4d4d, #ffe066, #5cd65c, #66ccff);
  min-height:100vh;
  padding:20px;
  color:#fff;
}
#titleBar { text-align:center; font-size:32px; font-weight:bold; margin-bottom:12px; text-shadow:2px 2px #000; }
#welcomeScreen, #adminLogin, #userSelect, #userPinScreen { max-width:420px; margin:20px auto; text-align:center; }
#mainContainer { display:flex; gap:15px; width:100%; min-height:75vh; }
.segment { flex:1; background:rgba(255,255,255,0.08); border-radius:12px; padding:15px; backdrop-filter: blur(6px); overflow-y:auto; box-shadow:0 6px 18px rgba(0,0,0,0.35); }
button { padding:10px; border:none; border-radius:8px; cursor:pointer; margin-top:10px; font-weight:700; }
.inputBox { width:100%; padding:10px; margin-top:10px; border-radius:8px; border:none; font-size:15px; }
.accountItem { background:rgba(255,255,255,0.06); padding:10px; border-radius:8px; margin-top:8px; cursor:pointer; }
.accountItem.selected { background:rgba(255,255,255,0.18); color:#000; font-weight:700; }
.history { max-height:60vh; overflow-y:auto; padding:8px; }
.history-item { padding:10px; margin-bottom:8px; border-radius:8px; color:#fff; }
.history-item.add { background:#2a8f4a; }
.history-item.remove { background:#b33a3a; }
#extraVerse { font-size:16px; line-height:1.4; text-align:center; }
.small { font-size:12px; opacity:0.9; }
@media(max-width:900px){ #mainContainer{flex-direction:column;} }
</style>
</head>
<body>
<div id="titleBar">Cash App</div>

<!-- Welcome / Login -->
<div id="welcomeScreen">
  <h2>Welcome</h2>
  <button id="adminBtn" style="background:#2c3e50; color:#fff; width:180px;">Admin</button>
  <button id="userBtn" style="background:#16a085; color:#fff; width:180px;">User</button>
</div>

<div id="adminLogin" style="display:none;">
  <h3>Admin Login</h3>
  <input id="adminPassInput" type="password" class="inputBox" placeholder="Enter admin password" />
  <div>
    <button id="adminLoginBtn" style="background:#34495e; color:#fff;">Login</button>
    <button id="adminResetButton" style="background:#9b59b6; color:#fff; margin-left:8px;">Reset Admin Password</button>
  </div>
  <p class="small">If no admin password is set yet, entering one will create it.</p>
</div>

<div id="userSelect" style="display:none;">
  <h3>Select your account (alias)</h3>
  <div id="userAccountList"></div>
</div>

<div id="userPinScreen" style="display:none; text-align:center;">
  <h3>Enter your 4-digit PIN</h3>
  <input id="userPinInput" type="password" maxlength="4" class="inputBox" style="width:160px; text-align:center; font-size:18px;" />
  <div>
    <button id="userPinBtn" style="background:#16a085; color:#fff;">Login</button>
    <button id="userBackBtn" style="background:#7f8c8d; color:#fff; margin-left:8px;">Back</button>
  </div>
</div>

<!-- Main app area -->
<div id="appScreen" style="display:none;">
  <div id="mainContainer">

    <!-- Segment 1: Accounts (left) -->
    <div class="segment" id="segment1">
      <h3>Accounts</h3>
      <div id="accountList"></div>

      <div id="adminControls" style="display:none; margin-top:14px;">
        <h4>Admin Controls</h4>
        <input id="accFullName" class="inputBox" placeholder="Full name (required)" />
        <input id="accAlias" class="inputBox" placeholder="Alias (shown to users)" />
        <input id="accAge" class="inputBox" placeholder="Age" />
        <input id="accGender" class="inputBox" placeholder="Gender" />
        <input id="accPin" class="inputBox" placeholder="4-digit PIN (required)" maxlength="4" />
        <div style="display:flex; gap:8px;">
          <button id="createAccBtn" style="background:#2980b9; color:#fff; flex:1;">Create Account</button>
          <button id="editAccBtn" style="background:#f39c12; color:#fff; flex:1;">Edit Selected</button>
        </div>
        <div style="display:flex; gap:8px; margin-top:8px;">
          <button id="deleteAccBtn" style="background:#e74c3c; color:#fff; flex:1;">Delete Selected</button>
          <button id="resetUserPinBtn" style="background:#27ae60; color:#fff; flex:1;">Reset User PIN</button>
        </div>
      </div>
    </div>

    <!-- Segment 2: Account Details (center-left) -->
    <div class="segment" id="segment2">
      <h3>Account Details</h3>
      <div id="userRealName" style="font-size:18px; margin-bottom:8px; color:#fff;"></div>
      <div>Total: <strong><span id="totalMoney">0</span></strong> UGX</div>
      <input id="amountInput" class="inputBox" placeholder="Amount" type="number" />
      <input id="reasonInput" class="inputBox" placeholder="Reason / Comment" />
      <div style="display:flex; gap:8px;">
        <button id="addMoneyBtn" style="background:#27ae60; color:#fff; flex:1;">Add Money</button>
        <button id="removeMoneyBtn" style="background:#c0392b; color:#fff; flex:1;">Remove Money</button>
      </div>
      <p class="small">(Users see this page read-only after PIN login.)</p>
    </div>

    <!-- Segment 3: Transaction History (center-right) -->
    <div class="segment" id="segment3">
      <h3>Transaction History</h3>
      <div class="history" id="historyList"></div>
    </div>

    <!-- Segment 4: Extra space with rotating verses -->
    <div class="segment" id="segment4">
      <h3>Verse (Seasonal)</h3>
      <div id="extraVerse">Loading verse...</div>
      <p class="small">Verse rotates every 6 hours (local time).</p>
    </div>

  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script>
// ---------------- Firebase config ----------------
const firebaseConfig = {
  apiKey: "AIzaSyDbW2RuOnSr4H7Cl0_CLu99ckPbrh2y4Gw",
  authDomain: "business-app-data.firebaseapp.com",
  databaseURL: "https://business-app-data-default-rtdb.firebaseio.com",
  projectId: "business-app-data",
  storageBucket: "business-app-data.firebasestorage.app",
  messagingSenderId: "64963134720",
  appId: "1:64963134720:web:f8dd72fbe82342b1f91fe5",
  measurementId: "G-21K1R3V7SH"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// App state
let mode = null; // 'admin' or 'user'
let currentAccountKey = null; // selected account
let currentUserKey = null; // for user after successful PIN login
let accountsCache = {};

// Elements
const welcome = document.getElementById('welcomeScreen');
const adminLogin = document.getElementById('adminLogin');
const userSelect = document.getElementById('userSelect');
const userPinScreen = document.getElementById('userPinScreen');
const appScreen = document.getElementById('appScreen');

const adminPassInput = document.getElementById('adminPassInput');
const adminLoginBtn = document.getElementById('adminLoginBtn');
const adminResetButton = document.getElementById('adminResetButton');

const accountListEl = document.getElementById('accountList');
const historyListEl = document.getElementById('historyList');
const totalMoneyEl = document.getElementById('totalMoney');
const userRealNameEl = document.getElementById('userRealName');

// buttons & inputs
const accFullName = document.getElementById('accFullName');
const accAlias = document.getElementById('accAlias');
const accAge = document.getElementById('accAge');
const accGender = document.getElementById('accGender');
const accPin = document.getElementById('accPin');

// admin control buttons
const createAccBtn = document.getElementById('createAccBtn');
const editAccBtn = document.getElementById('editAccBtn');
const deleteAccBtn = document.getElementById('deleteAccBtn');
const resetUserPinBtn = document.getElementById('resetUserPinBtn');
const resetAdminPassBtn = document.getElementById('resetAdminPassBtn');

const addMoneyBtn = document.getElementById('addMoneyBtn');
const removeMoneyBtn = document.getElementById('removeMoneyBtn');
const amountInput = document.getElementById('amountInput');
const reasonInput = document.getElementById('reasonInput');

const userAccountList = document.getElementById('userAccountList');
const userPinInput = document.getElementById('userPinInput');
const userPinBtn = document.getElementById('userPinBtn');
const userBackBtn = document.getElementById('userBackBtn');

// welcome buttons
document.getElementById('adminBtn').onclick = ()=>{ mode='admin'; welcome.style.display='none'; adminLogin.style.display='block'; };
document.getElementById('userBtn').onclick = ()=>{ mode='user'; welcome.style.display='none'; userSelect.style.display='block'; loadUserAccountList(); };

// ---------------- Admin login / reset ----------------
adminLoginBtn.onclick = async ()=>{
  const pass = (adminPassInput.value||'').trim();
  adminPassInput.value='';
  if(!pass) return alert('Enter a password');
  const snap = await db.ref('admin/password').get();
  if(!snap.exists()){
    await db.ref('admin/password').set(pass);
    alert('Admin password created');
    enterAdmin();
    return;
  }
  if(snap.val()===pass){ enterAdmin(); }
  else alert('Wrong admin password');
};

adminResetButton.onclick = async ()=>{
  const ok = confirm('Reset admin password? This will overwrite existing admin password.');
  if(!ok) return;
  const newPass = prompt('Enter new admin password:');
  if(!newPass) return;
  await db.ref('admin/password').set(newPass);
  alert('Admin password updated');
};

function enterAdmin(){ adminLogin.style.display='none'; appScreen.style.display='block'; document.getElementById('adminControls').style.display='block'; loadAccountList(); }

// ---------------- Load user account list (for user to pick alias) ----------------
async function loadUserAccountList(){
  const snap = await db.ref('accounts').get();
  userAccountList.innerHTML='';
  snap.forEach(child=>{
    const a = normalizeAccount(child.key, child.val());
    const div = document.createElement('div');
    div.className='accountItem';
    div.innerText = a.alias || ('acct-'+child.key.slice(-4));
    div.onclick = ()=>{ currentAccountKey = child.key; userSelect.style.display='none'; userPinScreen.style.display='block'; };
    userAccountList.appendChild(div);
  });
}

userBackBtn.onclick = ()=>{ userPinScreen.style.display='none'; userSelect.style.display='block'; };

userPinBtn.onclick = async ()=>{
  const pin = (userPinInput.value||'').trim(); userPinInput.value='';
  if(!pin) return alert('Enter PIN');
  const snap = await db.ref('accounts/'+currentAccountKey+'/pin').get();
  if(!snap.exists()) return alert('Account pin not set');
  if(snap.val()===pin){ currentUserKey = currentAccountKey; enterUserView(); }
  else alert('Incorrect PIN');
};

function enterUserView(){ userPinScreen.style.display='none'; appScreen.style.display='block'; document.getElementById('adminControls').style.display='none'; // user: read-only controls
  // hide add/remove buttons for users
  addMoneyBtn.style.display='none'; removeMoneyBtn.style.display='none'; loadAccountList(); loadAccountDetails(currentUserKey); }

// ---------------- Normalize / migrate account structure ----------------
function normalizeAccount(key, raw){
  const a = raw || {};
  const normalized = {
    fullName: a.fullName || a.fullname || a.name || a.full_name || 'Unknown',
    alias: a.alias || a.aliasName || a.nickname || ('acct-'+key.slice(-4)),
    age: a.age || a.Age || '',
    gender: a.gender || a.sex || '',
    pin: a.pin || a.PIN || '',
    balance: (typeof a.balance!=='undefined')?a.balance:((typeof a.total!=='undefined')?a.total:((typeof a.AccountBalance!=='undefined')?a.AccountBalance:0))
  };
  return normalized;
}

// Write migration back for missing fields
async function migrateAccountIfNeeded(key, raw){
  const a = normalizeAccount(key, raw);
  const updates = {};
  // check and set fields only if missing
  if(!raw) raw = {};
  if(!raw.fullName && a.fullName!=='Unknown') updates.fullName = a.fullName;
  if(!raw.alias && a.alias) updates.alias = a.alias;
  if(typeof raw.balance==='undefined') updates.balance = a.balance;
  if(!raw.pin && a.pin) updates.pin = a.pin;
  if(updates && Object.keys(updates).length>0){
    await db.ref('accounts/'+key).update(updates);
  }
}

// ---------------- Load account list for admin (with migration) ----------------
async function loadAccountList(){
  const snap = await db.ref('accounts').get();
  accountsCache = {};
  accountListEl.innerHTML = '';
  snap.forEach(async child=>{
    const key = child.key; const raw = child.val();
    await migrateAccountIfNeeded(key, raw);
    const a = normalizeAccount(key, raw);
    accountsCache[key]=a;
    const div = document.createElement('div');
    div.className='accountItem';
    div.innerText = a.alias + (a.fullName?(' - '+a.fullName):'');
    div.onclick = ()=>{ // select
      currentAccountKey = key;
      document.querySelectorAll('#accountList .accountItem').forEach(el=>el.classList.remove('selected'));
      div.classList.add('selected');
      loadAccountDetails(key);
    };
    accountListEl.appendChild(div);
  });
}

// ---------------- Load account details and live listeners ----------------
let listeners = [];
function clearListeners(){ listeners.forEach(l=>l.off()); listeners = []; }
async function loadAccountDetails(key){
  if(!key) return;
  clearListeners();
  const acctRef = db.ref('accounts/'+key);
  // live update for balance
  const balRef = acctRef.child('balance');
  balRef.on('value', snap=>{ totalMoneyEl.innerText = snap.val() || 0; });
  listeners.push(balRef);
  // read full info once
  const snap = await acctRef.get(); const raw = snap.val()||{};
  const a = normalizeAccount(key, raw);
  userRealNameEl.innerText = 'Name: ' + (a.fullName || '');
  // load history listener
  const histRef = acctRef.child('history');
  histRef.on('value', s=>{
    const val = s.val() || {};
    historyListEl.innerHTML='';
    const entries = Object.values(val).sort((x,y)=> (y.timestamp||0)-(x.timestamp||0));
    entries.forEach(it=>{
      const div = document.createElement('div');
      div.className = 'history-item ' + (it.type==='add'?'add':'remove');
      const comment = it.comment || it.reason || '';
      const ts = it.timestamp ? new Date(it.timestamp).toLocaleString() : '';
      div.innerHTML = `<strong>${it.type==='add'?'+':'-'} ${it.amount} UGX</strong><div class='small'>${comment}</div><div class='small'>${ts}</div>`;
      historyListEl.appendChild(div);
    });
  });
  listeners.push(histRef);
}

// ---------------- Add / Remove Money (admin only) ----------------
createAccBtn.onclick = async ()=>{
  const fullName = (accFullName.value||'').trim();
  const alias = (accAlias.value||'').trim();
  const age = (accAge.value||'').trim();
  const gender = (accGender.value||'').trim();
  const pin = (accPin.value||'').trim();
  if(!fullName || !alias || !pin) return alert('Full name, alias and PIN are required');
  const ref = db.ref('accounts').push();
  await ref.set({ fullName, alias, age, gender, pin, balance:0 });
  accFullName.value=''; accAlias.value=''; accAge.value=''; accGender.value=''; accPin.value='';
  loadAccountList();
};

editAccBtn.onclick = async ()=>{
  if(!currentAccountKey) return alert('Select account to edit');
  // prompt for fields (prefill with existing)
  const raw = (await db.ref('accounts/'+currentAccountKey).get()).val() || {};
  const fullName = prompt('Full name', raw.fullName||raw.fullname||'');
  if(fullName===null) return; // cancel
  const alias = prompt('Alias', raw.alias||''); if(alias===null) return;
  const age = prompt('Age', raw.age||''); if(age===null) return;
  const gender = prompt('Gender', raw.gender||''); if(gender===null) return;
  await db.ref('accounts/'+currentAccountKey).update({ fullName, alias, age, gender });
  alert('Account info updated');
  loadAccountList();
};

deleteAccBtn.onclick = async ()=>{
  if(!currentAccountKey) return alert('Select account first');
  const ok = confirm('Delete this account and all its data?'); if(!ok) return;
  await db.ref('accounts/'+currentAccountKey).remove(); currentAccountKey=null; loadAccountList();
};

resetUserPinBtn.onclick = async ()=>{
  if(!currentAccountKey) return alert('Select account first');
  const newPin = prompt('Enter new 4-digit PIN'); if(!newPin || newPin.length!==4) return alert('PIN must be 4 digits');
  await db.ref('accounts/'+currentAccountKey+'/pin').set(newPin); alert('User PIN updated');
};

resetAdminPassBtn.onclick = async ()=>{
  const newPass = prompt('Enter new admin password'); if(!newPass) return; await db.ref('admin/password').set(newPass); alert('Admin password updated');
};

addMoneyBtn.onclick = async ()=>{
  if(mode!=='admin') return; if(!currentAccountKey) return alert('Select account');
  const amt = Number(amountInput.value); const comment = (reasonInput.value||'').trim();
  if(!amt) return alert('Enter amount');
  const ref = db.ref('accounts/'+currentAccountKey);
  const balSnap = await ref.child('balance').get(); let bal = balSnap.exists()?balSnap.val():0; bal += amt; await ref.child('balance').set(bal);
  await ref.child('history').push({ type:'add', amount:amt, comment, timestamp:Date.now() }); amountInput.value=''; reasonInput.value='';
};

removeMoneyBtn.onclick = async ()=>{
  if(mode!=='admin') return; if(!currentAccountKey) return alert('Select account');
  const amt = Number(amountInput.value); const comment = (reasonInput.value||'').trim();
  if(!amt) return alert('Enter amount');
  const ref = db.ref('accounts/'+currentAccountKey);
  const balSnap = await ref.child('balance').get(); let bal = balSnap.exists()?balSnap.val():0; bal -= amt; await ref.child('balance').set(bal);
  await ref.child('history').push({ type:'remove', amount:amt, comment, timestamp:Date.now() }); amountInput.value=''; reasonInput.value='';
};

// ---------------- Bible verses rotation in Segment 4 ----------------
const verses = [
  { ref:'Luke 2:10-11', text:'But the angel said to them, "Do not be afraid. I bring you good news that will cause great joy for all the people. Today in the town of David a Savior has been born to you; he is the Messiah, the Lord."' },
  { ref:'Isaiah 9:6', text:'For to us a child is born, to us a son is given, and the government will be on his shoulders. And he will be called Wonderful Counselor, Mighty God, Everlasting Father, Prince of Peace.' },
  { ref:'Matthew 1:23', text:'"The virgin will conceive and give birth to a son, and they will call him Immanuel" (which means "God with us").' },
  { ref:'John 1:14', text:'The Word became flesh and made his dwelling among us. We have seen his glory, the glory of the one and only Son, who came from the Father, full of grace and truth.' }
];
function showVerse(index){ const v = verses[index % verses.length]; document.getElementById('extraVerse').innerHTML = `<em>"${v.text}"</em><div class='small' style='margin-top:8px;'>${v.ref}</div>`; }
// rotate every 6 hours (21600000 ms). Also pick a random verse on load.
showVerse(Math.floor(Math.random()*verses.length)); setInterval(()=>{ const i = Math.floor(Math.random()*verses.length); showVerse(i); }, 21600000);

// ---------------- On load ensure admin/password and initial migration handled ----------------
(async function init(){
  // ensure admin/password exists? don't create a default password for security.
  // perform a one-time migration pass: iterate accounts and normalize missing fields
  const snap = await db.ref('accounts').get();
  if(snap.exists()){
    const updates = {};
    snap.forEach(child=>{
      const k = child.key; const raw = child.val(); const norm = normalizeAccount(k, raw);
      const need = {};
      if(!raw) return;
      if(!raw.fullName && norm.fullName!=='Unknown') need.fullName = norm.fullName;
      if(!raw.alias && norm.alias) need.alias = norm.alias;
      if(typeof raw.balance==='undefined') need.balance = norm.balance;
      if(!raw.pin && norm.pin) need.pin = norm.pin;
      if(Object.keys(need).length>0) updates['accounts/'+k] = need;
    });
    if(Object.keys(updates).length>0) await db.ref().update(updates);
  }
})();

</script>
</body>
</html>